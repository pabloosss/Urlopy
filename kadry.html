<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel Kadrowy</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    h2 { margin-top: 40px; }
  </style>
</head>
<body>
  <h1>Panel Kadrowy</h1>

  <div id="adminPanel" style="display:none;">
    <h2>Dodaj pracownika</h2>
    <input id="noweImie" placeholder="Imię i nazwisko" />
    <input id="dni" type="number" placeholder="Liczba dni urlopowych" value="20" />
    <select id="przelozony">
      <option value="">-- Wybierz przełożonego --</option>
    </select>
    <button onclick="dodajPracownika()">Dodaj</button>

    <h2>Lista pracowników</h2>
    <table id="tabelaPracownikow">
      <thead><tr><th>Imię</th><th>Dni urlopu</th><th>Przełożony</th><th>Akcje</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="wnioskiPanel">
    <h2>Wnioski urlopowe</h2>
    <table id="tabelaWnioskow">
      <thead><tr><th>Imię</th><th>Od</th><th>Do</th><th>Status</th><th>Akcje</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let data, rola, login;

    async function wczytajDane() {
      const res = await fetch('baza.json');
      data = await res.json();
      rola = sessionStorage.getItem("rola");
      login = sessionStorage.getItem("login");

      if (rola === "admin") {
        document.getElementById("adminPanel").style.display = "block";
        const przel = document.getElementById("przelozony");
        data.managerowie.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.login;
          opt.textContent = m.login;
          przel.appendChild(opt);
        });
      }

      pokazPracownikow();
      pokazWnioski();
    }

    function pokazPracownikow() {
      const tbody = document.querySelector("#tabelaPracownikow tbody");
      tbody.innerHTML = "";
      if (rola !== "admin") return;

      data.pracownicy.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.imie}</td>
          <td>${p.dni}</td>
          <td>${p.szef || ""}</td>
          <td><button onclick="usunPracownika('${p.imie}')">Usuń</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function pokazWnioski() {
      const tbody = document.querySelector("#tabelaWnioskow tbody");
      tbody.innerHTML = "";
      data.wnioski.forEach((w, i) => {
        const prac = data.pracownicy.find(p => p.imie === w.imie);
        if (rola === "manager" && prac?.szef !== login) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.imie}</td>
          <td>${w.od}</td>
          <td>${w.do}</td>
          <td>${w.status}</td>
          <td>
            <button onclick="zmienStatus(${i}, 'zaakceptowany')">Akceptuj</button>
            <button onclick="zmienStatus(${i}, 'odrzucony')">Odrzuć</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function dodajPracownika() {
      const imie = document.getElementById("noweImie").value;
      const dni = parseInt(document.getElementById("dni").value);
      const szef = document.getElementById("przelozony").value;

      data.pracownicy.push({ imie, dni, szef });
      await zapisz();

      pokazPracownikow();
      alert("Dodano pracownika");
    }

    async function usunPracownika(imie) {
      data.pracownicy = data.pracownicy.filter(p => p.imie !== imie);
      await zapisz();
      pokazPracownikow();
    }

    async function zmienStatus(index, status) {
      data.wnioski[index].status = status;
      await zapisz();
      pokazWnioski();
    }

    async function zapisz() {
      await fetch('baza.json', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
    }

    wczytajDane();
  </script>
</body>
</html>
