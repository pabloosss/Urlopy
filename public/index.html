<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerlog Urlopy alfa 0.1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --primary:#0d6efd; --bg:#f6f9ff;
      --present:#e8ffe8;            /* obecny */
      --submitted:#fff4e5;          /* pomarańcz (oczekuje) */
      --mgr:#e7f1ff;                /* niebieski (po akcept. kier.) */
      --approved:#d1e7dd;           /* zielony (zatwierdzony) */
      --rejected:#fde2e2;           /* czerwony (odrzucony) */
      --weekend:#f0f0f0; --todayOutline:#0d6efd;
    }
    body{background:var(--bg)}
    .brand-bar{background:linear-gradient(90deg,var(--primary),#37a0ff);color:#fff}
    .shadow-soft{box-shadow:0 8px 20px rgba(13,110,253,.12)}
    .card{border:0;border-radius:1rem} .btn{border-radius:.8rem}
    .nav-pills .nav-link.active{background:var(--primary)}
    .table thead th{background:#eef5ff}
    .required::after{content:" *"; color:#dc3545}

    /* Kalendarz */
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem;}
    .cal-grid > .head{font-size:.8rem; color:#6c757d; text-align:center}
    .cal-day{border-radius:.8rem; padding:.5rem; min-height:84px; border:1px solid #e9ecef; position:relative;}
    .cal-day .d{position:absolute; top:.35rem; right:.5rem; font-size:.8rem; color:#6c757d;}
    .cal-day.present{background:var(--present)}
    .cal-day.submitted{background:var(--submitted)}
    .cal-day.manager_approved{background:var(--mgr)}
    .cal-day.approved{background:var(--approved)}
    .cal-day.rejected{background:var(--rejected)}
    .cal-day.weekend{background:var(--weekend)}
    .cal-day.today{ outline:2px solid var(--todayOutline); outline-offset:-2px }
    .badge-dot{display:inline-block; width:.6rem; height:.6rem; border-radius:50%; margin-right:.35rem}
    .pill-filter .btn{border-radius:999px}

    /* Notyfikacje (dropdown dzwonka) */
    .notif-item{display:flex; gap:.75rem; padding:.5rem .75rem; border-bottom:1px solid #f1f3f5}
    .notif-item:last-child{border-bottom:0}
    .notif-icon{width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px}
    .notif-icon.submitted{background:#fff4e5; color:#b35c00}
    .notif-icon.manager_approved{background:#e7f1ff; color:#0b72b9}
    .notif-icon.approved{background:#d1e7dd; color:#0f5132}
    .notif-icon.rejected{background:#fde2e2; color:#842029}
    .notif-actions .btn{padding:.15rem .4rem}
    .dropdown-menu-notif{width:380px; max-width:90vw}
    .notif-empty{padding:1rem; text-align:center; color:#6c757d}
  </style>
</head>
<body>
<header class="brand-bar py-2 shadow-soft">
  <div class="container d-flex align-items-center gap-3">
    <h1 class="h6 mb-0 fw-bold">Emerlog Urlopy alfa 0.1</h1>
    <div class="ms-auto d-flex align-items-center gap-2">
      <!-- DZWONEK POWIADOMIEŃ -->
      <div class="dropdown">
        <button class="btn btn-light btn-sm position-relative" id="btnBell" data-bs-toggle="dropdown" aria-expanded="false" title="Powiadomienia">
          <i class="fa-regular fa-bell"></i>
          <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
        </button>
        <div class="dropdown-menu dropdown-menu-end p-0 dropdown-menu-notif" id="notifMenu">
          <div class="p-2 d-flex align-items-center justify-content-between border-bottom">
            <div class="btn-group btn-group-sm" role="group" aria-label="Filtr powiadomień">
              <button class="btn btn-outline-primary active" id="nfTabUnread">Nieprzeczytane</button>
              <button class="btn btn-outline-secondary" id="nfTabAll">Wszystkie</button>
            </div>
            <button class="btn btn-link btn-sm text-decoration-none" id="nfMarkAll">Oznacz wszystkie</button>
          </div>
          <div id="notifList"></div>
        </div>
      </div>

      <span id="loggedAs" class="small"></span>
      <button class="btn btn-light btn-sm" id="btnLogout" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
    </div>
  </div>
</header>

<main class="container my-4">
  <!-- Auth -->
  <section id="authSection" class="row justify-content-center">
    <div class="col-lg-5">
      <div class="card shadow-soft"><div class="card-body p-4">
        <div class="text-center mb-3">
          <div class="display-6">Zaloguj się</div>
          <div class="text-muted">Konta demo: admin/manager/worker (hasło: 1)</div>
        </div>
        <form id="loginForm" class="needs-validation" novalidate>
          <div class="mb-3"><label class="form-label required">E-mail</label><input type="email" class="form-control" id="loginEmail" required value="admin@demo.local"></div>
          <div class="mb-3"><label class="form-label required">Hasło</label><input type="password" class="form-control" id="loginPass" required value="1"></div>
          <div class="d-grid gap-2"><button class="btn btn-light btn-outline-dark" type="submit"><i class="fa-solid fa-right-to-bracket"></i> Zaloguj</button></div>
      </form></div></div>
    </div>
  </section>

  <!-- App -->
  <section id="appSection" style="display:none">
    <div class="row g-3">
      <div class="col-lg-3">
        <div class="card shadow-soft"><div class="card-body">
          <ul class="nav nav-pills flex-column gap-2" id="mainNav">
            <li class="nav-item"><button data-target="dashboard" class="nav-link active w-100 text-start"><i class="fa-solid fa-gauge-high me-2"></i>Pulpit</button></li>
            <li class="nav-item"><button data-target="calendar" class="nav-link w-100 text-start"><i class="fa-regular fa-calendar me-2"></i>Kalendarz</button></li>
            <li class="nav-item"><button data-target="leaves" class="nav-link w-100 text-start"><i class="fa-regular fa-calendar-days me-2"></i>Wnioski <span id="badgeLeaves" class="badge text-bg-danger ms-1 d-none"></span></button></li>
            <li class="nav-item"><button data-target="employees" class="nav-link w-100 text-start"><i class="fa-solid fa-id-card me-2"></i>Pracownicy</button></li>
            <li class="nav-item"><button data-target="reports" class="nav-link w-100 text-start"><i class="fa-solid fa-chart-simple me-2"></i>Raporty</button></li>
          </ul>
        </div></div>
      </div>

      <div class="col-lg-9">
        <!-- Dashboard -->
        <div id="view-dashboard" class="card shadow-soft"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="h5 mb-1" id="dashHello">Witaj</div>
              <div class="text-muted small" id="dashDate"></div>
            </div>
            <button class="btn btn-primary btn-sm" id="btnQuickLeave"><i class="fa-solid fa-plus"></i> Nowy wniosek</button>
          </div>
          <div class="row g-3">
            <div class="col-md-4"><div class="border rounded-4 p-3 h-100">
              <div class="d-flex align-items-center gap-2"><i class="fa-regular fa-sun fa-lg text-primary"></i>
                <div><div class="small text-muted">Urlop – zostało (rok)</div><div class="fs-4" id="vacationInfo">—</div>
                  <div class="small text-muted" id="subBalances"></div>
                </div>
              </div>
            </div></div>
            <div class="col-md-4"><div class="border rounded-4 p-3 h-100">
              <div class="d-flex align-items-center gap-2"><i class="fa-solid fa-inbox fa-lg text-primary"></i>
                <div><div class="small text-muted">Wnioski do decyzji</div><div class="fs-4" id="pendingInfo">0</div></div>
              </div>
            </div></div>
            <div class="col-md-4"><div class="border rounded-4 p-3 h-100">
              <div class="d-flex align-items-center gap-2"><i class="fa-regular fa-calendar-check fa-lg text-primary"></i>
                <div><div class="small text-muted">Dzisiejszy status</div><div class="fs-6" id="todayStatus">—</div></div>
              </div>
            </div></div>
          </div>

          <!-- Najbliższe 7 dni (mini-heatmapa) -->
          <div class="mt-4">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="h6 mb-0">Najbliższe 7 dni – obłożenie</div>
            </div>
            <div id="next7" class="d-flex gap-2 flex-wrap"></div>
          </div>
        </div></div>

        <!-- Kalendarz -->
        <div id="view-calendar" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Kalendarz obecności</h2>
            <div class="d-flex gap-2 align-items-center">
              <select id="calEmployee" class="form-select form-select-sm" style="min-width:240px"></select>
              <input type="month" id="calMonth" class="form-control form-control-sm" />
              <button class="btn btn-sm btn-outline-primary" id="btnNewLeaveCal"><i class="fa-solid fa-plus"></i> Wniosek</button>
            </div>
          </div>
          <div class="mb-2 small">
            <span class="badge bg-success-subtle text-success border me-1"><span class="badge-dot" style="background:#198754"></span>Obecny</span>
            <span class="badge bg-warning-subtle text-warning border me-1"><span class="badge-dot" style="background:#ffc107"></span>Oczekuje</span>
            <span class="badge bg-info-subtle text-info border me-1"><span class="badge-dot" style="background:#0dcaf0"></span>Po akceptacji kier.</span>
            <span class="badge bg-success-subtle text-success border me-1"><span class="badge-dot" style="background:#198754"></span>Zatwierdzony</span>
            <span class="badge bg-danger-subtle text-danger border me-1"><span class="badge-dot" style="background:#dc3545"></span>Odrzucony</span>
          </div>
          <div id="calGrid" class="cal-grid"></div>
        </div></div>

        <!-- Wnioski -->
        <div id="view-leaves" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Wnioski urlopowe</h2>
            <div><button class="btn btn-primary btn-sm" id="btnNewLeave"><i class="fa-solid fa-plane-departure"></i> Nowy wniosek</button></div>
          </div>

          <!-- Filtry statusu -->
          <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <div class="btn-group pill-filter btn-group-sm" role="group" id="leaveFilters">
              <button type="button" class="btn btn-outline-primary active" data-filter="pending">Oczekujące</button>
              <button type="button" class="btn btn-outline-primary" data-filter="approved">Zaakceptowane</button>
              <button type="button" class="btn btn-outline-primary" data-filter="rejected">Odrzucone</button>
              <button type="button" class="btn btn-outline-secondary" data-filter="all">Wszystkie</button>
            </div>
            <input type="month" class="form-control form-control-sm ms-auto" id="leaveMonth" />
            <select class="form-select form-select-sm" id="leaveEmployeeFilter" style="min-width:220px"></select>
            <div class="d-none d-md-inline small text-muted">Filtry zapamiętują się automatycznie</div>
          </div>

          <!-- Akcje zbiorcze (HR) -->
          <div class="mb-2 d-flex gap-2" id="bulkActions" style="display:none">
            <button class="btn btn-success btn-sm" id="btnBulkApprove"><i class="fa-solid fa-check-double"></i> Zatwierdź zaznaczone</button>
            <button class="btn btn-danger btn-sm" id="btnBulkReject"><i class="fa-solid fa-ban"></i> Odrzuć zaznaczone</button>
          </div>

          <div class="table-responsive"><table class="table align-middle" id="leaveTable">
            <thead><tr>
              <th style="width:36px"><input type="checkbox" id="chkAll"></th>
              <th>Pracownik</th><th>Rodzaj</th><th>Od</th><th>Do</th><th>Dni</th><th>Status</th><th></th>
            </tr></thead><tbody></tbody></table></div>
          <div id="leaveEmpty" class="text-center text-muted py-4 d-none">Brak wniosków w tej kategorii.</div>
        </div></div>

        <!-- Pracownicy -->
        <div id="view-employees" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Pracownicy</h2>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" id="btnNewEmp"><i class="fa-solid fa-user-plus"></i> Dodaj</button>
            </div>
          </div>
          <div class="table-responsive"><table class="table align-middle" id="empTable"><thead><tr>
            <th>Imię i nazwisko</th><th>E-mail</th><th>Rola</th><th>Kierownik</th><th>Zatrudnienie</th><th>Start</th><th>Urlop (dni/rok)</th><th></th>
          </tr></thead><tbody></tbody></table></div>
        </div></div>

        <!-- Raporty (placeholder – logikę rozbudujemy) -->
        <div id="view-reports" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3"><h2 class="h5 mb-0">Raport (miesiąc)</h2></div>
          <form class="row g-3 mb-3" id="reportForm">
            <div class="col-md-4"><label class="form-label">Pracownik</label><select class="form-select" id="repEmployee"></select></div>
            <div class="col-md-4"><label class="form-label">Miesiąc</label><input type="month" class="form-control" id="repMonth"></div>
            <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100" type="submit"><i class="fa-solid fa-magnifying-glass"></i> Generuj</button></div>
          </form>
          <div id="repOut"></div>
        </div></div>
      </div>
    </div>
  </section>
</main>

<!-- Modale -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Wniosek urlopowy</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <form id="leaveForm" class="modal-body row g-3">
    <input type="hidden" id="leaveId">
    <div class="col-md-6"><label class="form-label">Pracownik</label><select class="form-select" id="leaveUser"></select></div>
    <div class="col-md-6"><label class="form-label">Rodzaj</label><select class="form-select" id="leaveType"></select></div>
    <div class="col-md-6"><label class="form-label required">Od</label><input type="date" class="form-control" id="leaveFrom" required></div>
    <div class="col-md-6"><label class="form-label required">Do</label><input type="date" class="form-control" id="leaveTo" required></div>
    <div class="col-12"><label class="form-label">Komentarz</label><input class="form-control" id="leaveComment"></div>
    <div class="col-12 d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Anuluj</button><button class="btn btn-primary" type="submit">Złóż wniosek</button></div>
  </form>
</div></div></div>

<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Dane pracownika</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <form id="empForm" class="modal-body row g-3">
    <input type="hidden" id="empId">
    <div class="col-md-6"><label class="form-label required">Imię i nazwisko</label><input class="form-control" id="empName" required></div>
    <div class="col-md-6"><label class="form-label required">E-mail (login)</label><input type="email" class="form-control" id="empEmail" required></div>
    <div class="col-md-4"><label class="form-label required">Rola</label>
      <select class="form-select" id="empRole" required>
        <option value="employee">Pracownik</option>
        <option value="manager">Kierownik</option>
        <option value="admin">Administrator</option>
      </select>
    </div>
    <div class="col-md-4"><label class="form-label">Kierownik</label><select class="form-select" id="empManager"></select></div>
    <div class="col-md-4"><label class="form-label">Zatrudnienie</label>
      <select class="form-select" id="empEmployment">
        <option value="UOP">UOP</option>
        <option value="JDG">JDG</option>
      </select>
    </div>
    <div class="col-md-4"><label class="form-label">Start zatrudnienia</label><input type="date" class="form-control" id="empStartDate"></div>
    <div class="col-md-4"><label class="form-label">Urlop (dni/rok)</label><input type="number" class="form-control" id="empVacationDays" min="0" step="1" value="20"></div>
    <div class="col-12 d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Anuluj</button><button class="btn btn-primary" type="submit">Zapisz</button></div>
  </form>
</div></div></div>

<script>
const API_BASE = '';
let TOKEN = null;
const state = { user:null, data:{ users:[], leaves:[], org:{hoursPerDay:8} } };

// ====== tools
function api(path,opts={}){ opts.headers=Object.assign({'Content-Type':'application/json'},opts.headers||{}); if(TOKEN) opts.headers.Authorization='Bearer '+TOKEN; return fetch(API_BASE+path,opts).then(async r=>{ if(!r.ok) throw new Error(await r.text()); return r.json(); }); }
function toDate(x){ const d=new Date(x); d.setHours(0,0,0,0); return d; }
function isWeekend(d){ const day=d.getDay(); return day===0 || day===6; }
function monthKey(d){ d=new Date(d); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function businessDaysBetween(from,to){ let d1=toDate(from), d2=toDate(to); if(d2<d1) return 0; let c=0,d=new Date(d1); while(d<=d2){ if(!isWeekend(d)) c++; d.setDate(d.getDate()+1);} return c; }
function timeAgo(ts){ if(!ts) return ''; const sec=Math.max(1,Math.floor((Date.now()-ts)/1000)); const units=[['d',86400],['h',3600],['m',60],['s',1]]; for(const [u,v] of units){ if(sec>=v) return Math.floor(sec/v)+' '+(u==='d'?'dni':u==='h'?'h':u==='m'?'min':'s')+' temu'; } return 'przed chwilą'; }

// ====== balances
function employmentFractionThisYear(user,year){ const start=user.startDate? new Date(user.startDate):null; const yStart=new Date(year,0,1), yEnd=new Date(year,11,31); if(!start||start<yStart) return 1; if(start>yEnd) return 0; const months=(12-(start.getMonth()+1))+1; return Math.min(1,Math.max(0,months/12)); }
function vacationUsedDays(userId,year){
  const list=state.data.leaves.filter(l=> l.userId===userId && l.status==='approved' && (l.type==='wypoczynkowy' || l.type==='na_zadanie') && new Date(l.to).getFullYear()>=year && new Date(l.from).getFullYear()<=year );
  let sum=0; for(const l of list){ const f=new Date(Math.max(new Date(`${year}-01-01`).getTime(), toDate(l.from).getTime())); const t=new Date(Math.min(new Date(`${year}-12-31`).getTime(), toDate(l.to).getTime())); sum += businessDaysBetween(f,t); }
  return sum;
}
function vacationBalance(user,year){ const total=Number(user.vacationDays??20)||20; const entitled=Math.ceil(total*employmentFractionThisYear(user,year)); const used=vacationUsedDays(user.id,year); const left=Math.max(0,entitled-used); return { total, entitled, used, left }; }

// ====== auth/sync
async function login(email,pass){ try{ const r=await api('/auth/login',{method:'POST', body: JSON.stringify({email, pass})}); TOKEN=r.token; state.user=r.user; await sync(); renderAfterLogin(); return true; }catch{ return false; } }
async function sync(){ const users=await api('/users'); const leaves=await api('/leaves'); state.data={ users, leaves, org:{hoursPerDay:8} }; }

function renderAfterLogin(){
  document.getElementById('authSection').style.display='none';
  document.getElementById('appSection').style.display='block';
  document.getElementById('btnLogout').style.display='inline-flex';
  document.getElementById('loggedAs').textContent = `${state.user.name} (${state.user.email})`;
  const now=new Date();
  document.getElementById('dashDate').textContent = now.toLocaleString('pl-PL',{dateStyle:'full'});
  document.getElementById('dashHello').textContent = `${state.user.name} · ${state.user.role==='admin'?'Admin':state.user.role==='manager'?'Kierownik':'Pracownik'}`;

  document.getElementById('calMonth').value = monthKey(now);
  document.getElementById('repMonth').value = monthKey(now);
  document.getElementById('leaveMonth').value = monthKey(now);

  if(!window._poll) window._poll=setInterval(refresh,8000);

  renderAll();
  showView('dashboard');
}

function showView(name){
  ['dashboard','calendar','leaves','employees','reports'].forEach(v=>{
    document.getElementById('view-'+v).style.display=(v===name)?'block':'none';
    document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.classList.toggle('active',btn.dataset.target===name));
  });
}

// ====== common helpers
function userById(id){ return state.data.users.find(u=>u.id===id); }
function subordinatesOf(managerId){ return state.data.users.filter(u=>u.managerId===managerId); }
function canManagerActOn(leave){ const me=state.user; return me.role==='manager' && subordinatesOf(me.id).some(u=>u.id===leave.userId) && leave.status==='submitted'; }
function canAdminApprove(leave){ return state.user.role==='admin' && leave.status==='manager_approved'; }
function canAdminReject(leave){ return state.user.role==='admin' && (leave.status==='submitted' || leave.status==='manager_approved'); }
function tLabel(type){
  return ({
    choroba:'Choroba', wypoczynkowy:'Urlop wypoczynkowy', odbior_swieto:'Odbiór za święto',
    opieka_dziecko:'Opieka nad dzieckiem', odbior_nadgodzin:'Odbiór nadgodzin', bezplatny:'Urlop bezpłatny',
    macierzynski:'Urlop macierzyński', na_zadanie:'Urlop na żądanie', ojcowski:'Urlop ojcowski'
  })[type] || type;
}
function statusBadge(s){
  const map={submitted:'warning', manager_approved:'info', approved:'success', rejected_manager:'danger', rejected_admin:'danger'};
  const txt={submitted:'Wysłany', manager_approved:'Po akceptacji kierownika', approved:'Zatwierdzony', rejected_manager:'Odrzucony (kier.)', rejected_admin:'Odrzucony (admin)'};
  return `<span class="badge text-bg-${map[s]||'light'}">${txt[s]||s}</span>`;
}

// ====== badges & dashboard
function renderBadges(){
  let n=0;
  if(state.user.role==='manager'){
    n = state.data.leaves.filter(l=> canManagerActOn(l)).length;
  } else if(state.user.role==='admin'){
    const submittedAll = state.data.leaves.filter(l=> l.status==='submitted').length;
    const managerApproved = state.data.leaves.filter(l=> l.status==='manager_approved').length;
    n = submittedAll + managerApproved; // Admin: widzi nowe + do finalnej
  }
  const b1=document.getElementById('badgeLeaves');
  [b1].forEach(b=>{ if(!b) return; if(n>0){ b.textContent=n; b.classList.remove('d-none'); } else { b.classList.add('d-none'); }});
}

// Dashboard top tiles
function renderDashboard(){
  const me = userById(state.user.id);
  const year=new Date().getFullYear(); const bal=vacationBalance(me,year);
  document.getElementById('vacationInfo').textContent=`${bal.left} / ${bal.entitled} dni`;
  document.getElementById('subBalances').textContent = `Na żądanie: —/4 · Opieka: —/2`;

  const today= new Date().toISOString().slice(0,10);
  const todays = state.data.leaves.filter(l=> l.userId===me.id && l.status==='approved' && toDate(l.from) <= toDate(today) && toDate(l.to) >= toDate(today));
  document.getElementById('todayStatus').textContent = todays.length? 'Nieobecny (urlop/absencja)' : 'Obecny';

  let n=0;
  if(state.user.role==='manager'){
    n = state.data.leaves.filter(l=> canManagerActOn(l)).length;
  } else if(state.user.role==='admin'){
    const submittedAll = state.data.leaves.filter(l=> l.status==='submitted').length;
    const managerApproved = state.data.leaves.filter(l=> l.status==='manager_approved').length;
    n = submittedAll + managerApproved;
  }
  document.getElementById('pendingInfo').textContent = String(n);

  // Najbliższe 7 dni – mini-heatmapa
  const box=document.getElementById('next7'); box.innerHTML='';
  const base=new Date(); base.setHours(0,0,0,0);
  for(let i=0;i<7;i++){
    const d=new Date(base); d.setDate(base.getDate()+i);
    const iso=d.toISOString().slice(0,10);
    const absent=state.data.leaves.filter(l=> l.status==='approved' && toDate(l.from)<=toDate(iso) && toDate(l.to)>=toDate(iso));
    const badge=absent.length>=3?'danger':absent.length>=1?'warning':'success';
    const el=document.createElement('div');
    el.className='border rounded-3 px-2 py-1 d-flex align-items-center gap-2 bg-white';
    el.innerHTML=`<strong>${d.toLocaleDateString('pl-PL',{weekday:'short'})}</strong> <span class="badge text-bg-${badge}">${absent.length}</span>`;
    box.appendChild(el);
  }
}

// ====== calendar
function getMonthDays(year,month){ const days = new Date(year, month, 0).getDate(); return Array.from({length:days}, (_,i)=> i+1); }
function mondayIndex(jsDay){ return (jsDay+6)%7; }

function dayState(userId, y, m, d){
  const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const leaves=state.data.leaves.filter(l=> l.userId===userId && toDate(l.from)<=toDate(iso) && toDate(l.to)>=toDate(iso));
  if(leaves.length===0) return { state: isWeekend(new Date(iso))?'weekend':'present', leaves:[] };
  // priorytet: approved > manager_approved > submitted > rejected
  let prio=null;
  for(const l of leaves){
    if(l.status==='approved'){ prio='approved'; break; }
    if(!prio && l.status==='manager_approved') prio='manager_approved';
    if(!prio && l.status==='submitted') prio='submitted';
    if(!prio && (l.status==='rejected_manager' || l.status==='rejected_admin')) prio='rejected';
  }
  return { state: prio||'present', leaves };
}

function fillEmployeeSelect(sel, keepId=null){
  sel.innerHTML='';
  let list=[];
  if(state.user.role==='admin'){ list = [...state.data.users]; }
  else if(state.user.role==='manager'){ list = [ userById(state.user.id), ...subordinatesOf(state.user.id) ]; }
  else { list = [ userById(state.user.id) ]; }

  list.sort((a,b)=>{
    const ma=userById(a.managerId||'')?.name||'', mb=userById(b.managerId||'')?.name||'';
    if(ma!==mb) return ma.localeCompare(mb,'pl');
    return (a.name||'').localeCompare(b.name||'','pl');
  });

  for(const u of list){ sel.insertAdjacentHTML('beforeend', `<option value="${u.id}">${u.name} ${u.id===state.user.id?'(ja)':''}</option>`); }
  if(keepId && list.some(u=>u.id===keepId)){ sel.value = keepId; } else if(!sel.value){ sel.value = state.user.id; }
}

function renderCalendar(){
  const sel=document.getElementById('calEmployee');
  const keep = sel.value || state.user.id;
  fillEmployeeSelect(sel, keep);

  const mk=document.getElementById('calMonth').value || monthKey(new Date());
  const [Y,M]=mk.split('-').map(Number);
  const days=getMonthDays(Y,M);
  const grid=document.getElementById('calGrid'); grid.innerHTML='';

  // headers
  const head=['Pn','Wt','Śr','Cz','Pt','So','Nd'];
  for(const h of head){ const div=document.createElement('div'); div.className='head'; div.textContent=h; grid.appendChild(div); }

  const first=new Date(Y, M-1, 1);
  const pad=mondayIndex(first.getDay());
  for(let i=0;i<pad;i++){ const d=document.createElement('div'); d.className='cal-day weekend'; grid.appendChild(d); }

  for(const d of days){
    const isoDay = `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const info = dayState(sel.value, Y, M, d);
    const div=document.createElement('div'); div.className=`cal-day ${info.state}`; div.innerHTML=`<div class="d">${d}</div>`;
    if(isoDay === new Date().toISOString().slice(0,10)) div.classList.add('today');

    if(info.leaves.length){
      const l=info.leaves[0];
      div.insertAdjacentHTML('beforeend', `<div class="small">${tLabel(l.type)}</div><div class="small">${(l.comment||'')}</div>`);
      const buttons=[];
      if(canManagerActOn(l)){
        buttons.push(`<button class="btn btn-sm btn-success" data-act="approve-mgr" data-id="${l.id}" title="Zatwierdź (kierownik)"><i class="fa-solid fa-check"></i></button>`);
        buttons.push(`<button class="btn btn-sm btn-danger" data-act="reject-mgr" data-id="${l.id}" title="Odrzuć (kierownik)"><i class="fa-solid fa-xmark"></i></button>`);
      }
      if(canAdminApprove(l)){
        buttons.push(`<button class="btn btn-sm btn-success" data-act="approve-adm" data-id="${l.id}" title="Zatwierdź (admin)"><i class="fa-solid fa-check-double"></i></button>`);
      }
      if(canAdminReject(l)){
        buttons.push(`<button class="btn btn-sm btn-danger" data-act="reject-adm" data-id="${l.id}" title="Odrzuć (admin)"><i class="fa-solid fa-ban"></i></button>`);
      }
      if(buttons.length){
        div.insertAdjacentHTML('beforeend', `<div class="mt-1 d-flex gap-1 flex-wrap">${buttons.join('')}</div>`);
      }
    } else {
      if(!isWeekend(new Date(isoDay))){
        div.insertAdjacentHTML('beforeend', `<div class="mt-2"><button class="btn btn-sm btn-outline-primary" data-act="new-leave-day" data-date="${isoDay}"><i class="fa-solid fa-plus"></i> Wniosek</button></div>`);
      }
    }
    grid.appendChild(div);
  }
}

// ====== leave types / forms
function leaveTypesForUser(uid){
  const u=userById(uid);
  if((u?.employment||'UOP')==='JDG'){
    return [['wypoczynkowy','Urlop wypoczynkowy'],['odbior_swieto','Odbiór za święto']];
  }
  return [
    ['wypoczynkowy','Urlop wypoczynkowy'],['na_zadanie','Urlop na żądanie'],['choroba','Choroba'],
    ['opieka_dziecko','Opieka nad dzieckiem'],['odbior_swieto','Odbiór za święto'],['odbior_nadgodzin','Odbiór nadgodzin'],
    ['bezplatny','Urlop bezpłatny'],['macierzynski','Urlop macierzyński'],['ojcowski','Urlop ojcowski']
  ];
}
function fillLeaveUserSelect(selectEl){
  selectEl.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];
  list.sort((a,b)=> (a.name||'').localeCompare(b.name||'','pl'));
  for(const u of list){ selectEl.insertAdjacentHTML('beforeend', `<option value="${u.id}">${u.name}${u.id===state.user.id?' (ja)':''}</option>`); }
}
function fillLeaveTypes(selectEl, uid){
  selectEl.innerHTML='';
  for(const [val,label] of leaveTypesForUser(uid)){ selectEl.insertAdjacentHTML('beforeend', `<option value="${val}">${label}</option>`); }
}
function openLeaveModal(id, presetDate=null){
  const m=new bootstrap.Modal('#leaveModal');
  const selUser=document.getElementById('leaveUser');
  fillLeaveUserSelect(selUser);
  const row=id? state.data.leaves.find(x=>x.id===id) : {id:cryptoRand(), userId:state.user.id, type:'wypoczynkowy', from:presetDate||new Date().toISOString().slice(0,10), to:presetDate||new Date().toISOString().slice(0,10), comment:''};
  document.getElementById('leaveId').value=row.id;
  selUser.value=row.userId;
  fillLeaveTypes(document.getElementById('leaveType'), row.userId);
  document.getElementById('leaveType').value=row.type;
  document.getElementById('leaveFrom').value=row.from;
  document.getElementById('leaveTo').value=row.to;
  document.getElementById('leaveComment').value=row.comment||'';
  m.show();
}
async function saveLeaveFromModal(ev){
  ev.preventDefault();
  const row={ id:document.getElementById('leaveId').value, userId:document.getElementById('leaveUser').value, type:document.getElementById('leaveType').value, from:document.getElementById('leaveFrom').value, to:document.getElementById('leaveTo').value, comment:document.getElementById('leaveComment').value };
  const exists=state.data.leaves.find(x=>x.id===row.id);
  await api('/leaves'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)});
  await refresh();
  bootstrap.Modal.getInstance(document.getElementById('leaveModal')).hide();
}
async function approveLeave(id, who){
  if(who==='mgr'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'manager_approved' })}); }
  else if(who==='adm'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'approved' })}); }
  await refresh();
}
async function rejectLeave(id, who){
  if(who==='mgr'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'rejected_manager' })}); }
  else if(who==='adm'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'rejected_admin' })}); }
  await refresh();
}
async function deleteLeave(id){ await api('/leaves/'+id,{method:'DELETE'}); await refresh(); }

// ====== leaves list with filters + bulk actions
function fillLeavesEmployeeFilter(){
  const sel=document.getElementById('leaveEmployeeFilter');
  sel.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];
  sel.insertAdjacentHTML('beforeend', `<option value="">Wszyscy</option>`);
  list.sort((a,b)=> (a.name||'').localeCompare(b.name||'','pl'));
  for(const u of list){ sel.insertAdjacentHTML('beforeend', `<option value="${u.id}">${u.name}${u.id===state.user.id?' (ja)':''}</option>`); }
  // hide filter for employee
  sel.parentElement.style.display = (state.user.role==='employee') ? 'none' : '';
}

function currentLeaveFilter(){ return localStorage.getItem('leaveFilter') || 'pending'; }
function setLeaveFilter(v){
  localStorage.setItem('leaveFilter', v);
  document.querySelectorAll('#leaveFilters .btn').forEach(b=> b.classList.toggle('active',b.dataset.filter===v));
}

function filterByStatus(rows, filter){
  if(filter==='approved') return rows.filter(l=> l.status==='approved');
  if(filter==='rejected') return rows.filter(l=> l.status==='rejected_manager' || l.status==='rejected_admin');
  if(filter==='pending') return rows.filter(l=> l.status==='submitted' || l.status==='manager_approved');
  return rows;
}
function filterByMonth(rows, mk){
  if(!mk) return rows;
  const [Y,M]=mk.split('-').map(Number);
  const first = new Date(Y, M-1, 1);
  const last = new Date(Y, M, 0);
  return rows.filter(l=> toDate(l.from) <= last && toDate(l.to) >= first);
}
function filterByEmployee(rows, uid){
  if(!uid) return rows;
  return rows.filter(l=> l.userId===uid);
}

function renderLeaves(){
  const tbody=document.querySelector('#leaveTable tbody'); tbody.innerHTML='';
  const empty=document.getElementById('leaveEmpty');
  const filter = currentLeaveFilter();
  const mk = document.getElementById('leaveMonth').value;
  const uid = document.getElementById('leaveEmployeeFilter').value;

  let rows=[...state.data.leaves];
  rows = filterByStatus(rows, filter);
  rows = filterByMonth(rows, mk);
  rows = filterByEmployee(rows, uid);

  rows.sort((a,b)=>{
    const prio = s=> ({submitted:1, manager_approved:2, approved:9, rejected_manager:10, rejected_admin:10}[s]||5);
    const p=prio(a.status)-prio(b.status); if(p!==0) return p;
    return (a.from||'').localeCompare(b.from||'');
  });

  const me=state.user;
  const showBulk = (me.role==='admin'); // tylko HR/Admin
  document.getElementById('bulkActions').style.display = showBulk ? '' : 'none';

  for(const l of rows){
    const u= userById(l.userId);
    const canActMgr = canManagerActOn(l);
    const canApprAdm = canAdminApprove(l);
    const canRejAdm  = canAdminReject(l);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${showBulk?`<input type="checkbox" class="chkRow" data-id="${l.id}">`:''}</td>
      <td>${u?.name||'—'}</td>
      <td>${tLabel(l.type)}</td>
      <td>${l.from}</td>
      <td>${l.to}</td>
      <td>${businessDaysBetween(l.from,l.to)}</td>
      <td>${statusBadge(l.status)}</td>
      <td class='text-end'>
        ${ (state.user.id===l.userId && l.status==='submitted') ? `<button class='btn btn-sm btn-outline-secondary me-1' data-act='editLeave' data-id='${l.id}' title="Edytuj"><i class='fa-regular fa-pen-to-square'></i></button><button class='btn btn-sm btn-outline-danger' data-act='delLeave' data-id='${l.id}' title="Usuń"><i class='fa-regular fa-trash-can'></i></button>` : '' }
        ${ canActMgr ? `<button class='btn btn-sm btn-success me-1' data-act='approve-mgr' data-id='${l.id}' title="Zatwierdź (kierownik)"><i class='fa-solid fa-check'></i></button><button class='btn btn-sm btn-danger' data-act='reject-mgr' data-id='${l.id}' title="Odrzuć (kierownik)"><i class='fa-solid fa-xmark'></i></button>` : '' }
        ${ canApprAdm ? `<button class='btn btn-sm btn-success me-1' data-act='approve-adm' data-id='${l.id}' title="Zatwierdź (admin)"><i class='fa-solid fa-check-double'></i></button>` : '' }
        ${ canRejAdm ? `<button class='btn btn-sm btn-danger' data-act='reject-adm' data-id='${l.id}' title="Odrzuć (admin)"><i class='fa-solid fa-ban'></i></button>` : '' }
      </td>`;
    tbody.appendChild(tr);
  }

  document.getElementById('chkAll').checked = false;
  empty.classList.toggle('d-none', rows.length>0);
}

// ====== employees (admin edit)
function renderEmployees(){
  const tbody=document.querySelector('#empTable tbody'); tbody.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];

  list.sort((a,b)=>{
    const ma=userById(a.managerId||'')?.name||'', mb=userById(b.managerId||'')?.name||'';
    if(ma!==mb) return ma.localeCompare(mb,'pl');
    return (a.name||'').localeCompare(b.name||'','pl');
  });

  for(const u of list){
    const mgr=userById(u.managerId||'');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td><span class='badge text-bg-${u.role==='admin'?'dark':u.role==='manager'?'info':'secondary'}'>${u.role}</span></td>
      <td>${mgr?mgr.name:'—'}</td>
      <td>${u.employment||'UOP'}</td>
      <td>${u.startDate||'—'}</td>
      <td>${u.vacationDays??20}</td>
      <td class='text-end'>
        ${state.user.role==='admin'
          ? `<button class='btn btn-sm btn-outline-secondary me-1' data-act='editEmp' data-id='${u.id}' title="Edytuj"><i class='fa-regular fa-pen-to-square'></i></button>
             <button class='btn btn-sm btn-outline-danger' data-act='delEmp' data-id='${u.id}' title="Usuń"><i class='fa-regular fa-trash-can'></i></button>`
          : '' }
      </td>`;
    tbody.appendChild(tr);
  }
}
function renderRepEmployees(){
  const sel=document.getElementById('repEmployee'); sel.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];
  list.sort((a,b)=> (a.name||'').localeCompare(b.name||'','pl'));
  for(const u of list){ sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`); }
}

// ====== employee modal
function openEmpModal(id){
  if(state.user.role!=='admin'){ alert('Tylko administrator może edytować pracowników.'); return; }
  const m=new bootstrap.Modal('#empModal');
  const sel=document.getElementById('empManager'); sel.innerHTML='<option value="">—</option>';
  state.data.users.filter(u=>u.role!=='employee').forEach(u=> sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`));
  const row=id? state.data.users.find(u=>u.id===id) : {id:cryptoRand(), name:'', email:'', role:'employee', managerId:'', employment:'UOP', startDate:'', pass:'1', vacationDays:20};
  document.getElementById('empId').value=row.id;
  document.getElementById('empName').value=row.name||'';
  document.getElementById('empEmail').value=row.email||'';
  document.getElementById('empRole').value=row.role||'employee';
  document.getElementById('empManager').value=row.managerId||'';
  document.getElementById('empEmployment').value=row.employment||'UOP';
  document.getElementById('empStartDate').value=row.startDate||'';
  document.getElementById('empVacationDays').value=row.vacationDays??20;
  m.show();
}
async function saveEmpFromModal(ev){
  ev.preventDefault();
  if(state.user.role!=='admin'){ alert('Tylko administrator może edytować pracowników.'); return; }
  const row={ id:document.getElementById('empId').value, name:document.getElementById('empName').value, email:document.getElementById('empEmail').value, role:document.getElementById('empRole').value, managerId:document.getElementById('empManager').value||null, employment:document.getElementById('empEmployment').value||'UOP', startDate:document.getElementById('empStartDate').value||null, pass:(undefined), vacationDays:Number(document.getElementById('empVacationDays').value)||20 };
  const exists=state.data.users.find(u=>u.id===row.id);
  await api('/users'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)});
  await refresh();
  bootstrap.Modal.getInstance(document.getElementById('empModal')).hide();
}
async function deleteEmp(id){ if(state.user.role!=='admin'){ alert('Tylko administrator może usuwać.'); return; } await api('/users/'+id,{method:'DELETE'}); await refresh(); }

// ====== Raport placeholder
document.getElementById('reportForm')?.addEventListener?.('submit', (e)=>{
  e.preventDefault();
  const uid=document.getElementById('repEmployee').value;
  const mk=document.getElementById('repMonth').value;
  const [Y,M]=mk.split('-').map(Number);
  const days = new Date(Y, M, 0).getDate();
  let present=0, submitted=0, mgr=0, approved=0, rejected=0;
  for(let d=1; d<=days; d++){
    const s = dayState(uid,Y,M,d).state;
    if(s==='present' && !isWeekend(new Date(`${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`))) present++;
    if(s==='submitted') submitted++; if(s==='manager_approved') mgr++; if(s==='approved') approved++; if(s==='rejected') rejected++;
  }
  document.getElementById('repOut').innerHTML=`<div class='border rounded-4 p-3'>
    <div class='row text-center'>
      <div class='col'><div class='small text-muted'>Obecny</div><div class='fs-4'>${present}</div></div>
      <div class='col'><div class='small text-muted'>Wysłane</div><div class='fs-4'>${submitted}</div></div>
      <div class='col'><div class='small text-muted'>Po akcept. kier.</div><div class='fs-4'>${mgr}</div></div>
      <div class='col'><div class='small text-muted'>Zatwierdzone</div><div class='fs-4'>${approved}</div></div>
      <div class='col'><div class='small text-muted'>Odrzucone</div><div class='fs-4'>${rejected}</div></div>
    </div>
  </div>`;
});

// ====== POWIADOMIENIA (frontend-only, bez backendu)
const notif = {
  show:'unread',                 // 'unread' | 'all'
  seen: new Set(),               // klucze: `${leafId}:${stage}`
  submittedSeenAt: {},           // 'pierwsze zobaczenie' submitted (dla "kiedy")
};
function loadNotifState(){
  try{
    const s=JSON.parse(localStorage.getItem('seenNotifsV1')||'[]'); notif.seen=new Set(s);
    notif.submittedSeenAt=JSON.parse(localStorage.getItem('submittedSeenAtV1')||'{}');
  }catch{}
}
function saveNotifState(){
  localStorage.setItem('seenNotifsV1', JSON.stringify([...notif.seen]));
  localStorage.setItem('submittedSeenAtV1', JSON.stringify(notif.submittedSeenAt||{}));
}
function notifKey(leaf, stage){ return `${leaf.id}:${stage}`; }
function buildNotifications(){
  const items=[];
  const me=state.user;
  for(const l of state.data.leaves){
    const u=userById(l.userId);
    // Manager: widzi submitted podopiecznych
    if(me.role==='manager' && subordinatesOf(me.id).some(x=>x.id===l.userId) && l.status==='submitted'){
      if(!notif.submittedSeenAt[l.id]) notif.submittedSeenAt[l.id]=Date.now();
      items.push({
        key: notifKey(l,'submitted_mgr'), icon:'submitted', text:`Nowy wniosek: ${u?.name||'—'} • ${tLabel(l.type)} • ${l.from}–${l.to}`,
        when: notif.submittedSeenAt[l.id], actions:['approve-mgr','reject-mgr'], leaf:l
      });
    }
    // Admin: submitted (info) + manager_approved (decyzja)
    if(me.role==='admin'){
      if(l.status==='submitted'){
        if(!notif.submittedSeenAt[l.id]) notif.submittedSeenAt[l.id]=Date.now();
        items.push({
          key: notifKey(l,'submitted_adm'), icon:'submitted', text:`Wniosek oczekuje na kierownika: ${u?.name||'—'} • ${tLabel(l.type)}`,
          when: notif.submittedSeenAt[l.id], actions:['reject-adm'], leaf:l
        });
      }
      if(l.status==='manager_approved'){
        const ts = l.decidedAtManager || Date.now();
        items.push({
          key: notifKey(l,'manager_approved'), icon:'manager_approved', text:`Po akceptacji kierownika: ${u?.name||'—'} • ${tLabel(l.type)} • ${l.from}–${l.to}`,
          when: ts, actions:['approve-adm','reject-adm'], leaf:l
        });
      }
    }
    // Pracownik: finalna decyzja (approved/rejected)
    if(me.id===l.userId){
      if(l.status==='approved'){
        const ts = l.decidedAtAdmin || Date.now();
        items.push({ key:notifKey(l,'approved'), icon:'approved', text:`Zatwierdzono wniosek • ${tLabel(l.type)} • ${l.from}–${l.to}`, when:ts, actions:[], leaf:l });
      }
      if(l.status==='rejected_manager' || l.status==='rejected_admin'){
        const ts = (l.decidedAtAdmin||l.decidedAtManager||Date.now());
        items.push({ key:notifKey(l,'rejected'), icon:'rejected', text:`Odrzucono wniosek • ${tLabel(l.type)} • ${l.from}–${l.to}`, when:ts, actions:[], leaf:l });
      }
    }
  }
  saveNotifState();
  return items.sort((a,b)=> (b.when||0)-(a.when||0)).slice(0,50);
}
function renderNotifBell(){
  loadNotifState();
  const list=buildNotifications();
  // badge
  const unread=list.filter(i=> !notif.seen.has(i.key)).length;
  const badge=document.getElementById('notifBadge');
  if(unread>0){ badge.textContent=unread; badge.classList.remove('d-none'); } else { badge.classList.add('d-none'); }

  // dropdown list
  const showUnread = (notif.show==='unread');
  const view = showUnread ? list.filter(i=> !notif.seen.has(i.key)) : list;
  const box=document.getElementById('notifList'); box.innerHTML='';
  if(view.length===0){
    box.innerHTML = `<div class="notif-empty"><i class="fa-regular fa-bell mb-1"></i><div>${showUnread?'Brak nowych powiadomień':'Brak powiadomień'}</div></div>`;
    return;
  }
  for(const n of view){
    const row=document.createElement('div'); row.className='notif-item';
    row.innerHTML = `
      <div class="notif-icon ${n.icon}"><i class="${n.icon==='submitted'?'fa-regular fa-envelope':n.icon==='manager_approved'?'fa-regular fa-user':n.icon==='approved'?'fa-solid fa-check': 'fa-solid fa-ban'}"></i></div>
      <div class="flex-grow-1">
        <div class="small">${n.text}</div>
        <div class="text-muted small">${timeAgo(n.when)}</div>
      </div>
      <div class="notif-actions d-flex gap-1">
        ${ n.actions.includes('approve-mgr') ? `<button class="btn btn-success btn-sm" data-act="approve-mgr" data-id="${n.leaf.id}" title="Zatwierdź (kierownik)"><i class="fa-solid fa-check"></i></button>` : '' }
        ${ n.actions.includes('reject-mgr') ? `<button class="btn btn-danger btn-sm" data-act="reject-mgr" data-id="${n.leaf.id}" title="Odrzuć (kierownik)"><i class="fa-solid fa-xmark"></i></button>` : '' }
        ${ n.actions.includes('approve-adm') ? `<button class="btn btn-success btn-sm" data-act="approve-adm" data-id="${n.leaf.id}" title="Zatwierdź (admin)"><i class="fa-solid fa-check-double"></i></button>` : '' }
        ${ n.actions.includes('reject-adm') ? `<button class="btn btn-danger btn-sm" data-act="reject-adm" data-id="${n.leaf.id}" title="Odrzuć (admin)"><i class="fa-solid fa-ban"></i></button>` : '' }
      </div>
    `;
    box.appendChild(row);
  }
}
function notifMarkAllRead(){
  const list=buildNotifications();
  list.forEach(n=> notif.seen.add(n.key));
  saveNotifState();
  renderNotifBell();
}

// ====== render all
function renderAll(){ renderDashboard(); renderCalendar(); fillLeavesEmployeeFilter(); renderLeaves(); renderEmployees(); renderRepEmployees(); renderBadges(); renderNotifBell(); }

// ====== refresh & events
async function refresh(){ await sync(); renderAll(); }
function cryptoRand(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }

// ====== events
document.addEventListener('DOMContentLoaded', ()=>{
  // auth
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const ok=await login(document.getElementById('loginEmail').value, document.getElementById('loginPass').value); if(!ok) alert('Nieprawidłowe dane logowania.'); });
  document.getElementById('btnLogout').addEventListener('click', ()=>{ clearInterval(window._poll); window._poll=null; location.reload(); });

  // nav
  document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.target)));

  // dashboard quick
  document.getElementById('btnQuickLeave').addEventListener('click', ()=> openLeaveModal());

  // calendar
  document.getElementById('calMonth').addEventListener('change', renderCalendar);
  document.getElementById('calEmployee').addEventListener('change', renderCalendar);
  document.getElementById('btnNewLeaveCal').addEventListener('click', ()=> openLeaveModal(null, (document.getElementById('calMonth').value||new Date().toISOString().slice(0,7))+'-01'));

  // leave modal
  document.getElementById('btnNewLeave').addEventListener('click', ()=> openLeaveModal());
  document.getElementById('leaveForm').addEventListener('submit', saveLeaveFromModal);
  document.getElementById('leaveUser').addEventListener('change', ()=> fillLeaveTypes(document.getElementById('leaveType'), document.getElementById('leaveUser').value));

  // leaves filters
  document.querySelectorAll('#leaveFilters .btn').forEach(b=> b.addEventListener('click', ()=>{ setLeaveFilter(b.dataset.filter); renderLeaves(); }));
  setLeaveFilter(currentLeaveFilter());
  document.getElementById('leaveMonth').addEventListener('change', renderLeaves);
  document.getElementById('leaveEmployeeFilter').addEventListener('change', renderLeaves);

  // bulk actions (admin)
  document.getElementById('chkAll').addEventListener('change', (e)=>{
    document.querySelectorAll('.chkRow').forEach(ch=> ch.checked = e.target.checked);
  });
  document.getElementById('btnBulkApprove').addEventListener('click', async ()=>{
    const ids=[...document.querySelectorAll('.chkRow:checked')].map(x=>x.dataset.id);
    for(const id of ids){ try{ await approveLeave(id,'adm'); }catch{} }
    await refresh();
  });
  document.getElementById('btnBulkReject').addEventListener('click', async ()=>{
    const ids=[...document.querySelectorAll('.chkRow:checked')].map(x=>x.dataset.id);
    for(const id of ids){ try{ await rejectLeave(id,'adm'); }catch{} }
    await refresh();
  });

  // global delegation (table + calendar + notifs)
  document.body.addEventListener('click', (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id; const act=b.dataset.act;
    if(act==='approve-mgr') approveLeave(id,'mgr');
    if(act==='reject-mgr') rejectLeave(id,'mgr');
    if(act==='approve-adm') approveLeave(id,'adm');
    if(act==='reject-adm') rejectLeave(id,'adm');
    if(act==='editLeave') openLeaveModal(id);
    if(act==='delLeave') deleteLeave(id);
    if(act==='new-leave-day') openLeaveModal(null, b.dataset.date);
    if(b.id==='nfMarkAll'){ notifMarkAllRead(); }
  });

  // dzwonek tabs
  document.getElementById('nfTabUnread').addEventListener('click', ()=>{ notif.show='unread'; document.getElementById('nfTabUnread').classList.add('btn-outline-primary'); document.getElementById('nfTabUnread').classList.add('active'); document.getElementById('nfTabAll').classList.remove('active'); renderNotifBell(); });
  document.getElementById('nfTabAll').addEventListener('click', ()=>{ notif.show='all'; document.getElementById('nfTabAll').classList.add('active'); document.getElementById('nfTabUnread').classList.remove('active'); renderNotifBell(); });

  // dropdown show -> odśwież
  document.getElementById('btnBell').addEventListener('click', ()=> renderNotifBell());
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
