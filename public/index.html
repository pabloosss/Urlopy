/* =========================================================
 * Emerlog Urlopy — FRONTEND (Supabase backend via server.js)
 * Endpointy: bez prefiksu `/api` (API_BASE = '').
 * ======================================================= */

const API_BASE = ''; // było '/api'

/* ------------------------- API helper ------------------------- */
const api = {
  async request(path, { method = 'GET', body, headers = {} } = {}) {
    const res = await fetch(`${API_BASE}${path}`, {
      method,
      headers: { 'Content-Type': 'application/json', ...headers },
      body: body ? JSON.stringify(body) : undefined,
      credentials: 'include',
    });

    if (!res.ok) {
      let errText = `HTTP ${res.status}`;
      try {
        errText = await res.text();
      } catch {}
      throw new Error(errText || `HTTP ${res.status}`);
    }

    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  },

  // Auth
  login: (email, pass) => api.request('/login', { method: 'POST', body: { email, pass } }),
  logout: () => api.request('/logout', { method: 'POST' }),
  me: () => api.request('/me'),

  // Users
  listUsers: () => api.request('/users'),
  createUser: (payload) => api.request('/users', { method: 'POST', body: payload }),
  updateUser: (id, payload) => api.request(`/users/${encodeURIComponent(id)}`, { method: 'PUT', body: payload }),
  deleteUser: (id) => api.request(`/users/${encodeURIComponent(id)}`, { method: 'DELETE' }),

  // Leaves
  listLeaves: (params = {}) => {
    const q = new URLSearchParams(params).toString();
    return api.request(`/leaves${q ? `?${q}` : ''}`);
  },
  createLeave: (payload) => api.request('/leaves', { method: 'POST', body: payload }),
  updateLeave: (id, payload) => api.request(`/leaves/${encodeURIComponent(id)}`, { method: 'PUT', body: payload }),
  approveLeave: (id, level) => api.request(`/leaves/${encodeURIComponent(id)}/approve`, { method: 'POST', body: { level } }),
  rejectLeave: (id, level, reason) => api.request(`/leaves/${encodeURIComponent(id)}/reject`, { method: 'POST', body: { level, reason } }),
};

/* ------------------------- UI utils ------------------------- */
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];

function toast(msg, type = 'info') {
  console.log(`[${type}]`, msg);
  alert(msg);
}

function formatDate(d) {
  if (!d) return '—';
  const dt = typeof d === 'string' ? new Date(d) : d;
  if (Number.isNaN(dt.getTime())) return '—';
  return dt.toLocaleDateString('pl-PL');
}

function statusBadge(status) {
  const map = {
    submitted:         { text: 'Oczekuje',      cls: 'bg-blue-100 text-blue-700' },
    manager_approved:  { text: 'Po kierowniku', cls: 'bg-amber-100 text-amber-700' },
    approved:          { text: 'Zatwierdzony',  cls: 'bg-emerald-100 text-emerald-700' },
    rejected:          { text: 'Odrzucony',     cls: 'bg-rose-100 text-rose-700' },
  };
  const s = map[status] || { text: status || '—', cls: 'bg-gray-100 text-gray-700' };
  return `<span class="badge ${s.cls}">${s.text}</span>`;
}

/* ------------------------- Auth flow ------------------------- */
async function initAuth() {
  const loginForm = $('#loginForm');

  if (loginForm) {
    // Strona logowania
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const pass = $('#loginPass').value.trim();
      try {
        await api.login(email, pass);
        location.replace('/');
      } catch (err) {
        toast('login failed', 'error');
      }
    });
    return;
  }

  // Strony za logowaniem
  try {
    const me = await api.me();
    window.__ME = me?.user || me || {};
    fillHeader();
    await initDashboard();
    initEmployees();
    initLeaves();
    initFilters();
  } catch {
    location.replace('/login.html');
  }
}

function fillHeader() {
  $('#topUserName') && ($('#topUserName').textContent = window.__ME?.name || '—');
  $('#topUserRole') && ($('#topUserRole').textContent = window.__ME?.role || '—');
  updateBell().catch(() => setBell(0));
}

async function updateBell() {
  const me = window.__ME || {};
  try {
    if (me.role === 'admin') {
      const list = await api.listLeaves({ status_in: 'submitted,manager_approved' });
      setBell(list?.length || 0);
    } else if (me.role === 'manager') {
      const list = await api.listLeaves({ status: 'submitted' });
      setBell(list?.length || 0);
    } else {
      setBell(0);
    }
  } catch {
    setBell(0);
  }
}

function setBell(n) {
  const badge = $('#notifBellCount');
  if (!badge) return;
  if (n > 0) {
    badge.textContent = String(n);
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

/* ------------------------- Dashboard ------------------------- */
async function initDashboard() {
  const hasAny = $('#dashDays') || $('#dashPending') || $('#dashToday');
  if (!hasAny) return;

  try {
    const me = window.__ME;
    const users = await api.listUsers(); // backend filtruje wg roli
    const my = users.find(u => u.id === me.id) || me;

    const used = Number(my.used_days ?? 0);
    const pool = Number(my.vacation_days ?? 0);
    $('#dashDays') && ($('#dashDays').textContent = `${Math.max(pool - used, 0)} / ${pool} dni`);

    const pending = await api.listLeaves({ scope: 'mine_or_team', status: 'submitted' });
    $('#dashPending') && ($('#dashPending').textContent = pending?.length ?? 0);

    const todayStr = new Date().toISOString().slice(0, 10);
    const todays = await api.listLeaves({ scope: 'mine', on: todayStr });
    const isOff = (todays || []).some(l => l.status === 'approved' || l.status === 'manager_approved');
    $('#dashToday') && ($('#dashToday').textContent = isOff ? 'Nieobecny' : 'Obecny');
  } catch (e) {
    console.warn(e);
  }
}

/* ------------------------- Employees ------------------------- */
function initEmployees() {
  if (!$('#employeesTable')) return;

  refreshUsers();
  $('#userAddBtn')?.addEventListener('click', () => openUserModal());
  $('#userModalForm')?.addEventListener('submit', onSaveUser);
  $('#userSearch')?.addEventListener('input', () => refreshUsers());
}

async function refreshUsers() {
  const tbody = $('#employeesTbody');
  if (!tbody) return;
  tbody.innerHTML = `<tr><td class="py-3 text-gray-500">Ładowanie…</td></tr>`;

  try {
    const users = await api.listUsers();

    // sort: najpierw wg manager_name, potem name
    users.sort((a, b) => {
      const am = (a.manager_name || '').localeCompare(b.manager_name || '');
      if (am !== 0) return am;
      return (a.name || '').localeCompare(b.name || '');
    });

    const q = ($('#userSearch')?.value || '').toLowerCase();

    const rows = (users || [])
      .filter(u =>
        !q ||
        (u.name || '').toLowerCase().includes(q) ||
        (u.email || '').toLowerCase().includes(q) ||
        (u.role || '').toLowerCase().includes(q) ||
        (u.manager_name || '').toLowerCase().includes(q)
      )
      .map(u => {
        return `
          <tr class="border-t">
            <td class="py-2 pr-3">${u.name ?? '—'}</td>
            <td class="py-2 pr-3">${u.email ?? '—'}</td>
            <td class="py-2 pr-3">
              <span class="badge ${u.role === 'admin' ? 'bg-slate-800 text-white' : u.role === 'manager' ? 'bg-cyan-100 text-cyan-700' : 'bg-gray-100 text-gray-700'}">${u.role}</span>
            </td>
            <td class="py-2 pr-3">${u.manager_name ?? '—'}</td>
            <td class="py-2 pr-3">${(u.employment || '').toUpperCase() || '—'}</td>
            <td class="py-2 pr-3">${formatDate(u.start_date)}</td>
            <td class="py-2 pr-3">${u.vacation_days ?? '—'}</td>
            <td class="py-2">
              <button class="btn-outline text-xs" data-edit="${u.id}">Edytuj</button>
              <button class="btn-outline text-xs ml-2" data-del="${u.id}">Usuń</button>
            </td>
          </tr>
        `;
      })
      .join('');

    tbody.innerHTML = rows || `<tr><td class="py-3 text-gray-500">Brak danych</td></tr>`;

    // akcje
    tbody.querySelectorAll('[data-edit]').forEach(btn =>
      btn.addEventListener('click', () => openUserModal(btn.dataset.edit))
    );
    tbody.querySelectorAll('[data-del]').forEach(btn =>
      btn.addEventListener('click', () => deleteUser(btn.dataset.del))
    );
  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td class="py-3 text-rose-600">Błąd wczytywania</td></tr>`;
  }
}

async function openUserModal(id) {
  const form = $('#userModalForm');
  form.reset();
  form.dataset.id = id || '';
  $('#umfTitle').textContent = id ? 'Edytuj pracownika' : 'Dodaj pracownika';

  // jeśli edycja — wczytaj dane do formularza
  if (id) {
    try {
      const list = await api.listUsers();
      const u = list.find(x => x.id === id);
      if (u) {
        $('#umfName').value = u.name || '';
        $('#umfEmail').value = u.email || '';
        $('#umfPass').value = '';
        $('#umfRole').value = u.role || 'employee';
        $('#umfManager').value = u.manager_id || '';
        $('#umfEmployment').value = u.employment || 'UOP';
        $('#umfStart').value = (u.start_date || '').slice(0, 10);
        $('#umfDays').value = u.vacation_days ?? 20;
      }
    } catch {
      toast('Błąd wczytania użytkownika', 'error');
    }
  }

  $('#userModal').classList.remove('hidden');
}
function closeUserModal() { $('#userModal').classList.add('hidden'); }
window.closeUserModal = closeUserModal; // używane w onclick w HTML

async function onSaveUser(e) {
  e.preventDefault();
  const id = e.currentTarget.dataset.id || '';
  const payload = {
    name: $('#umfName').value.trim(),
    email: $('#umfEmail').value.trim().toLowerCase(),
    pass: $('#umfPass').value.trim() || undefined,
    role: $('#umfRole').value,
    manager_id: $('#umfManager').value || null,
    employment: $('#umfEmployment').value || 'UOP',
    start_date: $('#umfStart').value || null,
    vacation_days: Number($('#umfDays').value || 20),
  };

  try {
    if (id) {
      await api.updateUser(id, payload);
      toast('Zapisano zmiany', 'success');
    } else {
      await api.createUser(payload);
      toast('Dodano pracownika', 'success');
    }
    closeUserModal();
    refreshUsers();
  } catch (err) {
    toast(`Błąd zapisu użytkownika: ${err.message || err}`, 'error');
  }
}

async function deleteUser(id) {
  if (!confirm('Na pewno usunąć pracownika?')) return;
  try {
    await api.deleteUser(id);
    refreshUsers();
  } catch {
    toast('Błąd usuwania', 'error');
  }
}

/* ------------------------- Leaves (Wnioski) ------------------------- */
function initLeaves() {
  if (!$('#leavesTable')) return;

  $('#leaveForm')?.addEventListener('submit', onSubmitLeave);
  $('#filterStatus')?.addEventListener('change', refreshLeaves);
  $('#filterMine')?.addEventListener('change', refreshLeaves);
  refreshLeaves();
}

async function refreshLeaves() {
  const tbody = $('#leavesTbody');
  if (!tbody) return;
  tbody.innerHTML = `<tr><td class="py-3 text-gray-500">Ładowanie…</td></tr>`;

  const status = $('#filterStatus')?.value || '';
  const onlyMine = $('#filterMine')?.checked;

  const params = {};
  if (status) params.status = status;
  if (onlyMine) params.scope = 'mine';

  try {
    const list = await api.listLeaves(params);

    const rows = (list || [])
      .map(l => `
        <tr class="border-t">
          <td class="py-2 pr-3">${l.user_name ?? '—'}</td>
          <td class="py-2 pr-3">${l.type ?? '—'}</td>
          <td class="py-2 pr-3">${formatDate(l.from)}</td>
          <td class="py-2 pr-3">${formatDate(l.to)}</td>
          <td class="py-2 pr-3">${l.comment ? `<span class="text-gray-700">${l.comment}</span>` : '—'}</td>
          <td class="py-2 pr-3">${statusBadge(l.status)}</td>
          <td class="py-2">${renderLeaveActions(l)}</td>
        </tr>
      `)
      .join('');

    tbody.innerHTML = rows || `<tr><td class="py-3 text-gray-500">Brak wniosków</td></tr>`;

    // podłącz akcje
    tbody.querySelectorAll('[data-approve]').forEach(btn =>
      btn.addEventListener('click', () => handleApprove(btn.dataset.approve, btn.dataset.level))
    );
    tbody.querySelectorAll('[data-reject]').forEach(btn =>
      btn.addEventListener('click', () => handleReject(btn.dataset.reject, btn.dataset.level))
    );
  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td class="py-3 text-rose-600">Błąd wczytywania</td></tr>`;
  }
}

function renderLeaveActions(l) {
  const me = window.__ME || {};
  const canManager = me.role === 'manager' && l.status === 'submitted';
  const canAdmin   = me.role === 'admin'   && l.status === 'manager_approved'; // admin po kierowniku
  const mine       = l.user_id === me.id   && l.status === 'submitted';

  const actions = [];
  if (canManager) {
    actions.push(`<button class="btn-outline text-xs" data-approve="${l.id}" data-level="manager">✅ Kierownik</button>`);
    actions.push(`<button class="btn-outline text-xs ml-2" data-reject="${l.id}" data-level="manager">❌ Kierownik</button>`);
  }
  if (canAdmin) {
    actions.push(`<button class="btn-outline text-xs" data-approve="${l.id}" data-level="admin">✅ Admin</button>`);
    actions.push(`<button class="btn-outline text-xs ml-2" data-reject="${l.id}" data-level="admin">❌ Admin</button>`);
  }
  if (mine) {
    actions.push(`<span class="text-xs text-gray-400 ml-2">edytuj/wycofaj – wkrótce</span>`);
  }
  return actions.join(' ');
}

async function handleApprove(id, level) {
  try {
    await api.approveLeave(id, level);
    toast('Zatwierdzono', 'success');
    await updateBell();
    refreshLeaves();
  } catch {
    toast('Błąd akceptacji', 'error');
  }
}

async function handleReject(id, level) {
  const reason = prompt('Powód odrzucenia (opcjonalnie):') || '';
  try {
    await api.rejectLeave(id, level, reason);
    toast('Odrzucono', 'success');
    await updateBell();
    refreshLeaves();
  } catch {
    toast('Błąd odrzucenia', 'error');
  }
}

async function onSubmitLeave(e) {
  e.preventDefault();
  const type = $('#lfType').value;
  const from = $('#lfFrom').value;
  const to = $('#lfTo').value;
  const comment = $('#lfComment').value.trim();

  try {
    await api.createLeave({ type, from, to, comment }); // user_id ustawi backend na podstawie sesji
    e.target.reset();
    toast('Wniosek wysłany', 'success');
    await updateBell();
    refreshLeaves();
  } catch (err) {
    toast(`Błąd zapisu wniosku: ${err.message || 'forbidden'}`, 'error');
  }
}

/* ------------------------- Drobne UI ------------------------- */
function initFilters() {
  // podświetl dzisiaj, jeśli w layout jest kalendarz z data-date="YYYY-MM-DD"
  const todayEl = document.querySelector(`[data-date="${new Date().toISOString().slice(0, 10)}"]`);
  if (todayEl) todayEl.classList.add('ring-2', 'ring-blue-500', 'rounded-md');
}

/* ------------------------- Boot ------------------------- */
document.addEventListener('DOMContentLoaded', initAuth);

// logout
$('#logoutBtn')?.addEventListener('click', async () => {
  try { await api.logout(); } catch {}
  location.replace('/login.html');
});
