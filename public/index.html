<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerlog Urlopy alfa 0.1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <style>
    :root{ --primary:#0d6efd; --bg:#f6f9ff; --present:#e8ffe8; --submitted:#fff4e5; --mgr:#fffbe5; --approved:#ffe5e5; --weekend:#f0f0f0; }
    body{background:var(--bg)} .brand-bar{background:linear-gradient(90deg,var(--primary),#37a0ff);color:#fff}
    .brand-logo{height:42px} .shadow-soft{box-shadow:0 8px 20px rgba(13,110,253,.12)}
    .card{border:0;border-radius:1rem} .btn{border-radius:.8rem}
    .nav-pills .nav-link.active{background:var(--primary)} .table thead th{background:#eef5ff}
    .required::after{content:" *"; color:#dc3545}
    /* Kalendarz */
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem;}
    .cal-day{border-radius:.8rem; padding:.5rem; min-height:84px; border:1px solid #e9ecef; position:relative;}
    .cal-day .d{position:absolute; top:.35rem; right:.5rem; font-size:.8rem; color:#6c757d;}
    .cal-day.present{background:var(--present)}
    .cal-day.submitted{background:var(--submitted)}
    .cal-day.manager_approved{background:var(--mgr)}
    .cal-day.approved{background:var(--approved)}
    .cal-day.weekend{background:var(--weekend)}
    .cal-legend .badge{margin-right:.5rem}
    .badge-dot{display:inline-block; width:.75rem; height:.75rem; border-radius:50%; margin-right:.25rem}
    .btn-icon{padding:.35rem .6rem}
  </style>
</head>
<body>
<header class="brand-bar py-2 shadow-soft">
  <div class="container d-flex align-items-center gap-3">
    <h1 class="h6 mb-0 fw-bold">Emerlog Urlopy alfa 0.1</h1>
    <div class="ms-auto d-flex align-items-center gap-3">
      <span id="badgeLeavesNav" class="badge text-bg-light d-none"></span>
      <span id="loggedAs" class="small"></span>
      <button class="btn btn-light btn-sm" id="btnLogout" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
    </div>
  </div>
</header>

<main class="container my-4">
  <!-- Auth -->
  <section id="authSection" class="row justify-content-center">
    <div class="col-lg-5">
      <div class="card shadow-soft"><div class="card-body p-4">
        <div class="text-center mb-3">
          <div class="display-6">Zaloguj się</div>
          <div class="text-muted">Konta demo: admin/manager/worker (hasło: 1)</div>
        </div>
        <form id="loginForm" class="needs-validation" novalidate>
          <div class="mb-3"><label class="form-label required">E-mail</label><input type="email" class="form-control" id="loginEmail" required value="admin@demo.local"></div>
          <div class="mb-3"><label class="form-label required">Hasło</label><input type="password" class="form-control" id="loginPass" required value="1"></div>
          <div class="d-grid gap-2"><button class="btn btn-primary" type="submit"><i class="fa-solid fa-right-to-bracket"></i> Zaloguj</button></div>
        </form>
      </div></div>
    </div>
  </section>

  <!-- App -->
  <section id="appSection" style="display:none">
    <div class="row g-3">
      <div class="col-lg-3">
        <div class="card shadow-soft"><div class="card-body">
          <ul class="nav nav-pills flex-column gap-2" id="mainNav">
            <li class="nav-item"><button data-target="dashboard" class="nav-link active w-100 text-start"><i class="fa-solid fa-gauge-high me-2"></i>Pulpit</button></li>
            <li class="nav-item"><button data-target="calendar" class="nav-link w-100 text-start"><i class="fa-regular fa-calendar me-2"></i>Kalendarz</button></li>
            <li class="nav-item"><button data-target="leaves" class="nav-link w-100 text-start"><i class="fa-regular fa-calendar-days me-2"></i>Wnioski <span id="badgeLeaves" class="badge text-bg-danger ms-1 d-none"></span></button></li>
            <li class="nav-item"><button data-target="employees" class="nav-link w-100 text-start"><i class="fa-solid fa-id-card me-2"></i>Pracownicy</button></li>
            <li class="nav-item"><button data-target="reports" class="nav-link w-100 text-start"><i class="fa-solid fa-chart-simple me-2"></i>Raporty</button></li>
          </ul>
        </div></div>
      </div>

      <div class="col-lg-9">
        <!-- Dashboard -->
        <div id="view-dashboard" class="card shadow-soft"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Pulpit</h2>
            <div class="text-muted" id="dashDate"></div>
          </div>
          <div class="row g-3">
            <div class="col-md-4"><div class="border rounded-4 p-3 h-100"><div class="d-flex align-items-center gap-2"><i class="fa-regular fa-sun fa-lg text-primary"></i><div><div class="small text-muted">Urlop – zostało (rok)</div><div class="fs-4" id="vacationInfo">—</div></div></div></div></div>
            <div class="col-md-4"><div class="border rounded-4 p-3 h-100"><div class="d-flex align-items-center gap-2"><i class="fa-solid fa-users-viewfinder fa-lg text-primary"></i><div><div class="small text-muted">Wnioski do decyzji</div><div class="fs-4" id="pendingInfo">0</div></div></div></div></div>
            <div class="col-md-4"><div class="border rounded-4 p-3 h-100"><div class="d-flex align-items-center gap-2"><i class="fa-regular fa-calendar-check fa-lg text-primary"></i><div><div class="small text-muted">Dzisiejszy status</div><div class="fs-6" id="todayStatus">—</div></div></div></div></div>
          </div>
        </div></div>

        <!-- Kalendarz -->
        <div id="view-calendar" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Kalendarz obecności</h2>
            <div class="d-flex gap-2 align-items-center">
              <select id="calEmployee" class="form-select form-select-sm" style="min-width:240px"></select>
              <input type="month" id="calMonth" class="form-control form-control-sm" />
              <button class="btn btn-sm btn-outline-primary" id="btnNewLeaveCal"><i class="fa-solid fa-plus"></i> Wniosek</button>
            </div>
          </div>
          <div class="cal-legend mb-3">
            <span class="badge bg-success-subtle text-success border">Obecny</span>
            <span class="badge bg-warning-subtle text-warning border">Oczekuje (submitted)</span>
            <span class="badge bg-warning text-dark border">Po akceptacji Kierownika</span>
            <span class="badge bg-danger-subtle text-danger border">Zatwierdzony urlop</span>
          </div>
          <div id="calGrid" class="cal-grid"></div>
        </div></div>

        <!-- Wnioski -->
        <div id="view-leaves" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3"><h2 class="h5 mb-0">Wnioski urlopowe</h2><div><button class="btn btn-primary btn-sm" id="btnNewLeave"><i class="fa-solid fa-plane-departure"></i> Nowy wniosek</button></div></div>
          <div class="table-responsive"><table class="table align-middle" id="leaveTable"><thead><tr><th>Pracownik</th><th>Rodzaj</th><th>Od</th><th>Do</th><th>Dni</th><th>Status</th><th></th></tr></thead><tbody></tbody></table></div>
        </div></div>

        <!-- Pracownicy -->
        <div id="view-employees" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3"><h2 class="h5 mb-0">Pracownicy</h2><div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" id="btnNewEmp"><i class="fa-solid fa-user-plus"></i> Dodaj</button>
          </div></div>
          <div class="table-responsive"><table class="table align-middle" id="empTable"><thead><tr><th>Imię i nazwisko</th><th>E-mail</th><th>Rola</th><th>Kierownik</th><th>Kontrakt</th><th>Zatrudnienie</th><th>Start</th><th>Urlop (dni/rok)</th><th></th></tr></thead><tbody></tbody></table></div>
        </div></div>

        <!-- Raporty (prosto) -->
        <div id="view-reports" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3"><h2 class="h5 mb-0">Raport (miesiąc)</h2></div>
          <form class="row g-3 mb-3" id="reportForm">
            <div class="col-md-4"><label class="form-label">Pracownik</label><select class="form-select" id="repEmployee"></select></div>
            <div class="col-md-4"><label class="form-label">Miesiąc</label><input type="month" class="form-control" id="repMonth"></div>
            <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100" type="submit"><i class="fa-solid fa-magnifying-glass"></i> Generuj</button></div>
          </form>
          <div id="repOut"></div>
        </div></div>
      </div>
    </div>
  </section>
</main>

<!-- Modale -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Wniosek urlopowy</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <form id="leaveForm" class="modal-body row g-3">
    <input type="hidden" id="leaveId">
    <div class="col-md-6"><label class="form-label">Pracownik</label><select class="form-select" id="leaveUser"></select></div>
    <div class="col-md-6"><label class="form-label">Rodzaj</label><select class="form-select" id="leaveType"></select></div>
    <div class="col-md-6"><label class="form-label required">Od</label><input type="date" class="form-control" id="leaveFrom" required></div>
    <div class="col-md-6"><label class="form-label required">Do</label><input type="date" class="form-control" id="leaveTo" required></div>
    <div class="col-12"><label class="form-label">Komentarz</label><input class="form-control" id="leaveComment"></div>
    <div class="col-12 d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Anuluj</button><button class="btn btn-primary" type="submit">Złóż wniosek</button></div>
  </form>
</div></div></div>

<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Dane pracownika</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <form id="empForm" class="modal-body row g-3">
    <input type="hidden" id="empId">
    <div class="col-md-6"><label class="form-label required">Imię i nazwisko</label><input class="form-control" id="empName" required></div>
    <div class="col-md-6"><label class="form-label required">E-mail (login)</label><input type="email" class="form-control" id="empEmail" required></div>
    <div class="col-md-4"><label class="form-label required">Rola</label>
      <select class="form-select" id="empRole" required>
        <option value="employee">Pracownik</option>
        <option value="manager">Kierownik</option>
        <option value="admin">Administrator</option>
      </select>
    </div>
    <div class="col-md-4"><label class="form-label">Kierownik</label><select class="form-select" id="empManager"></select></div>
    <div class="col-md-4"><label class="form-label">Zatrudnienie</label>
      <select class="form-select" id="empEmployment">
        <option value="UOP">UOP</option>
        <option value="JDG">JDG</option>
      </select>
    </div>
    <div class="col-md-4"><label class="form-label">Start zatrudnienia</label><input type="date" class="form-control" id="empStartDate"></div>
    <div class="col-md-4"><label class="form-label">Urlop (dni/rok)</label><input type="number" class="form-control" id="empVacationDays" min="0" step="1" value="20"></div>
    <div class="col-12 d-flex justify-content-end gap-2"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Anuluj</button><button class="btn btn-primary" type="submit">Zapisz</button></div>
  </form>
</div></div></div>

<script>
const API_BASE = '';
let TOKEN = null;
const state = { user:null, data:{ users:[], leaves:[], org:{hoursPerDay:8} } };

// ====== narzędzia
function api(path,opts={}){ opts.headers=Object.assign({'Content-Type':'application/json'},opts.headers||{}); if(TOKEN) opts.headers.Authorization='Bearer '+TOKEN; return fetch(API_BASE+path,opts).then(async r=>{ if(!r.ok) throw new Error(await r.text()); return r.json(); }); }
function toDate(x){ const d=new Date(x); d.setHours(0,0,0,0); return d; }
function isWeekend(d){ const day=d.getDay(); return day===0 || day===6; }
function monthKey(d){ d=new Date(d); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function businessDaysBetween(from,to){ let d1=toDate(from), d2=toDate(to); if(d2<d1) return 0; let c=0,d=new Date(d1); while(d<=d2){ if(!isWeekend(d)) c++; d.setDate(d.getDate()+1);} return c; }

// ====== liczniki urlopu
function employmentFractionThisYear(user,year){ const start=user.startDate? new Date(user.startDate):null; const yStart=new Date(year,0,1), yEnd=new Date(year,11,31); if(!start||start<yStart) return 1; if(start>yEnd) return 0; const months=(12-(start.getMonth()+1))+1; return Math.min(1,Math.max(0,months/12)); }
function vacationUsedDays(userId,year){
  const list=state.data.leaves.filter(l=> l.userId===userId && l.status==='approved' && (l.type==='wypoczynkowy' || l.type==='na_zadanie') && new Date(l.to).getFullYear()>=year && new Date(l.from).getFullYear()<=year );
  let sum=0; for(const l of list){ const f=new Date(Math.max(new Date(`${year}-01-01`).getTime(), toDate(l.from).getTime())); const t=new Date(Math.min(new Date(`${year}-12-31`).getTime(), toDate(l.to).getTime())); sum += businessDaysBetween(f,t); }
  return sum;
}
function vacationBalance(user,year){ const total=Number(user.vacationDays??20)||20; const entitled=Math.ceil(total*employmentFractionThisYear(user,year)); const used=vacationUsedDays(user.id,year); const left=Math.max(0,entitled-used); return { total, entitled, used, left }; }

// ====== auth & sync
async function login(email,pass){ try{ const r=await api('/auth/login',{method:'POST', body: JSON.stringify({email, pass})}); TOKEN=r.token; state.user=r.user; await sync(); renderAfterLogin(); return true; }catch{ return false; } }
async function sync(){ const users=await api('/users'); const leaves=await api('/leaves'); state.data={ users, leaves, org:{hoursPerDay:8} }; }

function renderAfterLogin(){
  document.getElementById('authSection').style.display='none';
  document.getElementById('appSection').style.display='block';
  document.getElementById('btnLogout').style.display='inline-flex';
  document.getElementById('loggedAs').textContent = `${state.user.name} (${state.user.email})`;
  document.getElementById('dashDate').textContent = new Date().toLocaleString('pl-PL',{dateStyle:'full'});

  const now=new Date(); document.getElementById('calMonth').value = monthKey(now); document.getElementById('repMonth').value = monthKey(now);
  if(!window._poll) window._poll=setInterval(refresh,8000);

  renderAll();
  showView('dashboard');
}
function showView(name){
  ['dashboard','calendar','leaves','employees','reports'].forEach(v=>{
    document.getElementById('view-'+v).style.display=(v===name)?'block':'none';
    document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.classList.toggle('active',btn.dataset.target===name));
  });
}

function renderAll(){ renderDashboard(); renderCalendar(); renderLeaves(); renderEmployees(); renderRepEmployees(); renderBadges(); }

// ====== UI helpers
function statusBadge(s){
  const map={submitted:'warning', manager_approved:'warning', approved:'danger', rejected_manager:'secondary', rejected_admin:'secondary'};
  const txt={submitted:'Wysłany', manager_approved:'Po akceptacji kierownika', approved:'Zatwierdzony', rejected_manager:'Odrzucony (kierownik)', rejected_admin:'Odrzucony (admin)'};
  return `<span class="badge text-bg-${map[s]||'light'}">${txt[s]||s}</span>`;
}
function userById(id){ return state.data.users.find(u=>u.id===id); }
function subordinatesOf(managerId){ return state.data.users.filter(u=>u.managerId===managerId); }
function canManagerActOn(leave){ const me=state.user; return me.role==='manager' && subordinatesOf(me.id).some(u=>u.id===leave.userId) && leave.status==='submitted'; }
function canAdminActOn(leave){ const me=state.user; if(me.role!=='admin') return false; const applicant=userById(leave.userId); return (leave.status==='manager_approved') || (applicant?.role==='manager' && leave.status==='submitted'); }

// ====== dashboard
function renderDashboard(){
  const me = userById(state.user.id);
  const year=new Date().getFullYear(); const bal=vacationBalance(me,year);
  document.getElementById('vacationInfo').textContent=`${bal.left} / ${bal.entitled} dni`;

  const today= new Date().toISOString().slice(0,10);
  const todays = state.data.leaves.filter(l=> l.userId===me.id && l.status==='approved' && toDate(l.from) <= toDate(today) && toDate(l.to) >= toDate(today));
  document.getElementById('todayStatus').textContent = todays.length? 'Nieobecny (urlop/absencja)' : 'Obecny';

  // Pending count for my role
  let n=0;
  if(state.user.role==='manager'){
    n = state.data.leaves.filter(l=> canManagerActOn(l)).length;
  } else if(state.user.role==='admin'){
    n = state.data.leaves.filter(l=> canAdminActOn(l)).length;
  }
  document.getElementById('pendingInfo').textContent = String(n);
}

// ====== powiadomienia (badges)
function renderBadges(){
  let n=0;
  if(state.user.role==='manager') n = state.data.leaves.filter(l=> canManagerActOn(l)).length;
  else if(state.user.role==='admin') n = state.data.leaves.filter(l=> canAdminActOn(l)).length;
  const b1=document.getElementById('badgeLeaves');
  const b2=document.getElementById('badgeLeavesNav');
  [b1,b2].forEach(b=>{ if(!b) return; if(n>0){ b.textContent=n; b.classList.remove('d-none'); } else { b.classList.add('d-none'); }});
}

// ====== kalendarz
function fillEmployeeSelect(sel){
  sel.innerHTML='';
  let list=[];
  if(state.user.role==='admin'){ list = [...state.data.users]; }
  else if(state.user.role==='manager'){ list = [ userById(state.user.id), ...subordinatesOf(state.user.id) ]; }
  else { list = [ userById(state.user.id) ]; }
  // sort: najpierw kierownikami, w grupie po nazwisku
  list.sort((a,b)=>{
    const ma=userById(a.managerId||'')?.name||'', mb=userById(b.managerId||'')?.name||'';
    if(ma!==mb) return ma.localeCompare(mb,'pl');
    return (a.name||'').localeCompare(b.name||'','pl');
  });
  for(const u of list){ sel.insertAdjacentHTML('beforeend', `<option value="${u.id}">${u.name} ${u.id===state.user.id?'(ja)':''}</option>`); }
  if(!sel.value) sel.value = state.user.id;
}
function getMonthDays(year,month){ // month: 1-12
  const days = new Date(year, month, 0).getDate();
  return Array.from({length:days}, (_,i)=> i+1);
}
function mondayIndex(jsDay){ // JS: Sun=0..Sat=6; my: Mon=0..Sun=6
  return (jsDay+6)%7;
}
function dayHasLeave(userId, y, m, d){
  const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const leaves=state.data.leaves.filter(l=> l.userId===userId && toDate(l.from)<=toDate(iso) && toDate(l.to)>=toDate(iso));
  if(leaves.length===0) return { state: isWeekend(new Date(iso))?'weekend':'present', leaves:[] };
  // priorytety: approved > manager_approved > submitted
  let prio='submitted';
  for(const l of leaves){
    if(l.status==='approved'){ prio='approved'; break; }
    if(l.status==='manager_approved'){ prio='manager_approved'; }
  }
  return { state: prio, leaves };
}
function renderCalendar(){
  const sel=document.getElementById('calEmployee'); fillEmployeeSelect(sel);
  const mk=document.getElementById('calMonth').value || monthKey(new Date());
  const [Y,M]=mk.split('-').map(Number);
  const days=getMonthDays(Y,M);
  const grid=document.getElementById('calGrid'); grid.innerHTML='';

  // nagłówki dni Pn..Nd
  const head=['Pn','Wt','Śr','Cz','Pt','So','Nd'];
  for(const h of head){ const div=document.createElement('div'); div.className='text-center small text-muted'; div.textContent=h; grid.appendChild(div); }

  // puste pola przed 1. dniem (pon-0)
  const first=new Date(Y, M-1, 1);
  const pad=mondayIndex(first.getDay());
  for(let i=0;i<pad;i++){ const d=document.createElement('div'); d.className='cal-day weekend'; grid.appendChild(d); }

  // dni
  for(const d of days){
    const info = dayHasLeave(sel.value, Y, M, d);
    const div=document.createElement('div');
    div.className=`cal-day ${info.state}`;
    div.innerHTML=`<div class="d">${d}</div>`;
    if(info.leaves.length){
      const l=info.leaves[0];
      const u=userById(l.userId);
      const tMap={
        choroba:'Choroba',
        wypoczynkowy:'Urlop wypoczynkowy',
        odbior_swieto:'Odbiór za święto',
        opieka_dziecko:'Opieka nad dzieckiem',
        odbior_nadgodzin:'Odbiór nadgodzin',
        bezplatny:'Urlop bezpłatny',
        macierzynski:'Urlop macierzyński',
        na_zadanie:'Urlop na żądanie',
        ojcowski:'Urlop ojcowski'
      };
      div.insertAdjacentHTML('beforeend', `<div class="small">${tMap[l.type]||l.type}</div><div class="small">${(l.comment||'')}</div>`);
      // akcje (kierownik/admin)
      if(canManagerActOn(l) || canAdminActOn(l)){
        div.insertAdjacentHTML('beforeend', `<div class="mt-1 d-flex gap-1 flex-wrap">
          ${canManagerActOn(l)?`<button class="btn btn-sm btn-success btn-icon" data-act="approve-mgr" data-id="${l.id}" title="Zatwierdź (kierownik)"><i class="fa-solid fa-check"></i></button>
          <button class="btn btn-sm btn-danger btn-icon" data-act="reject-mgr" data-id="${l.id}" title="Odrzuć (kierownik)"><i class="fa-solid fa-xmark"></i></button>`:''}
          ${canAdminActOn(l)?`<button class="btn btn-sm btn-success btn-icon" data-act="approve-adm" data-id="${l.id}" title="Zatwierdź (admin)"><i class="fa-solid fa-check-double"></i></button>
          <button class="btn btn-sm btn-danger btn-icon" data-act="reject-adm" data-id="${l.id}" title="Odrzuć (admin)"><i class="fa-solid fa-ban"></i></button>`:''}
        </div>`);
      }
    } else {
      // brak wniosku – skrót do utworzenia
      if(!isWeekend(new Date(`${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`))){
        div.insertAdjacentHTML('beforeend', `<div class="mt-2"><button class="btn btn-sm btn-outline-primary" data-act="new-leave-day" data-date="${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}"><i class="fa-solid fa-plus"></i> Wniosek</button></div>`);
      }
    }
    grid.appendChild(div);
  }
}

// ====== wnioski (lista)
function renderLeaves(){
  const tbody=document.querySelector('#leaveTable tbody'); tbody.innerHTML='';
  const rows=[...state.data.leaves].sort((a,b)=>{
    // priorytet: submitted -> manager_approved -> approved -> rejected*
    const prio = s=> ({submitted:1, manager_approved:2, approved:9, rejected_manager:10, rejected_admin:10}[s]||5);
    const p=prio(a.status)-prio(b.status); if(p!==0) return p;
    return (a.from||'').localeCompare(b.from||'');
  });
  for(const l of rows){
    const u= userById(l.userId);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${u?.name||'—'}</td>
      <td>${l.type}</td>
      <td>${l.from}</td>
      <td>${l.to}</td>
      <td>${businessDaysBetween(l.from,l.to)}</td>
      <td>${statusBadge(l.status)}</td>
      <td class='text-end'>
        ${ (state.user.id===l.userId && l.status==='submitted') ? `<button class='btn btn-sm btn-outline-secondary me-1' data-act='editLeave' data-id='${l.id}'><i class='fa-regular fa-pen-to-square'></i></button><button class='btn btn-sm btn-outline-danger' data-act='delLeave' data-id='${l.id}'><i class='fa-regular fa-trash-can'></i></button>` : '' }
        ${ canManagerActOn(l) ? `<button class='btn btn-sm btn-success me-1' data-act='approve-mgr' data-id='${l.id}'><i class='fa-solid fa-check'></i></button><button class='btn btn-sm btn-danger' data-act='reject-mgr' data-id='${l.id}'><i class='fa-solid fa-xmark'></i></button>` : '' }
        ${ canAdminActOn(l) ? `<button class='btn btn-sm btn-success me-1' data-act='approve-adm' data-id='${l.id}'><i class='fa-solid fa-check-double'></i></button><button class='btn btn-sm btn-danger' data-act='reject-adm' data-id='${l.id}'><i class='fa-solid fa-ban'></i></button>` : '' }
      </td>`;
    tbody.appendChild(tr);
  }
}

// ====== pracownicy (grupowanie po kierowniku + sort A→Z)
function renderEmployees(){
  const tbody=document.querySelector('#empTable tbody'); tbody.innerHTML='';
  // admin widzi wszystkich; manager: siebie + podopiecznych; employee: tylko siebie
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];

  // sort po kierowniku, potem po nazwisku
  list.sort((a,b)=>{
    const ma=userById(a.managerId||'')?.name||'', mb=userById(b.managerId||'')?.name||'';
    if(ma!==mb) return ma.localeCompare(mb,'pl');
    return (a.name||'').localeCompare(b.name||'','pl');
  });

  for(const u of list){
    const mgr=userById(u.managerId||'');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td><span class='badge text-bg-${u.role==='admin'?'dark':u.role==='manager'?'info':'secondary'}'>${u.role}</span></td>
      <td>${mgr?mgr.name:'—'}</td>
      <td>${u.contract||'1.0'}</td>
      <td>${u.employment||'UOP'}</td>
      <td>${u.startDate||'—'}</td>
      <td>${u.vacationDays??20}</td>
      <td class='text-end'>
        ${state.user.role==='admin'
          ? `<button class='btn btn-sm btn-outline-secondary me-1' data-act='editEmp' data-id='${u.id}'><i class='fa-regular fa-pen-to-square'></i></button>
             <button class='btn btn-sm btn-outline-danger' data-act='delEmp' data-id='${u.id}'><i class='fa-regular fa-trash-can'></i></button>`
          : '' }
      </td>`;
    tbody.appendChild(tr);
  }
}
function renderRepEmployees(){
  const sel=document.getElementById('repEmployee'); sel.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];
  list.sort((a,b)=> (a.name||'').localeCompare(b.name||'','pl'));
  for(const u of list){ sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`); }
}

// ====== modale — wnioski
function leaveTypesForUser(uid){
  const u=userById(uid);
  if((u?.employment||'UOP')==='JDG'){
    return [
      ['wypoczynkowy','Urlop wypoczynkowy'],
      ['odbior_swieto','Odbiór za święto']
    ];
  }
  return [
    ['wypoczynkowy','Urlop wypoczynkowy'],
    ['na_zadanie','Urlop na żądanie'],
    ['choroba','Choroba'],
    ['opieka_dziecko','Opieka nad dzieckiem'],
    ['odbior_swieto','Odbiór za święto'],
    ['odbior_nadgodzin','Odbiór nadgodzin'],
    ['bezplatny','Urlop bezpłatny'],
    ['macierzynski','Urlop macierzyński'],
    ['ojcowski','Urlop ojcowski']
  ];
}
function fillLeaveUserSelect(selectEl){
  selectEl.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];
  list.sort((a,b)=> (a.name||'').localeCompare(b.name||'','pl'));
  for(const u of list){ selectEl.insertAdjacentHTML('beforeend', `<option value="${u.id}">${u.name}${u.id===state.user.id?' (ja)':''}</option>`); }
}
function fillLeaveTypes(selectEl, uid){
  selectEl.innerHTML='';
  for(const [val,label] of leaveTypesForUser(uid)){ selectEl.insertAdjacentHTML('beforeend', `<option value="${val}">${label}</option>`); }
}
function openLeaveModal(id, presetDate=null){
  const m=new bootstrap.Modal('#leaveModal');
  const selUser=document.getElementById('leaveUser');
  fillLeaveUserSelect(selUser);
  const row=id? state.data.leaves.find(x=>x.id===id) : {id:cryptoRand(), userId:state.user.id, type:'wypoczynkowy', from:presetDate||new Date().toISOString().slice(0,10), to:presetDate||new Date().toISOString().slice(0,10), comment:''};
  document.getElementById('leaveId').value=row.id;
  selUser.value=row.userId;
  fillLeaveTypes(document.getElementById('leaveType'), row.userId);
  document.getElementById('leaveType').value=row.type;
  document.getElementById('leaveFrom').value=row.from;
  document.getElementById('leaveTo').value=row.to;
  document.getElementById('leaveComment').value=row.comment||'';
  m.show();
}
async function saveLeaveFromModal(ev){
  ev.preventDefault();
  const row={ id:document.getElementById('leaveId').value, userId:document.getElementById('leaveUser').value, type:document.getElementById('leaveType').value, from:document.getElementById('leaveFrom').value, to:document.getElementById('leaveTo').value, comment:document.getElementById('leaveComment').value };
  const exists=state.data.leaves.find(x=>x.id===row.id);
  await api('/leaves'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)});
  await refresh();
  bootstrap.Modal.getInstance(document.getElementById('leaveModal')).hide();
}
async function approveLeave(id, who){ // who: 'mgr' | 'adm'
  if(who==='mgr'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'manager_approved' })}); }
  else if(who==='adm'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'approved' })}); }
  await refresh();
}
async function rejectLeave(id, who){
  if(who==='mgr'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'rejected_manager' })}); }
  else if(who==='adm'){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status:'rejected_admin' })}); }
  await refresh();
}
async function deleteLeave(id){ await api('/leaves/'+id,{method:'DELETE'}); await refresh(); }

// ====== modale — pracownicy (admin only edycja)
function openEmpModal(id){
  if(state.user.role!=='admin'){ alert('Tylko administrator może edytować pracowników.'); return; }
  const m=new bootstrap.Modal('#empModal');
  const sel=document.getElementById('empManager'); sel.innerHTML='<option value="">—</option>';
  state.data.users.filter(u=>u.role!=='employee').forEach(u=> sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`));
  const row=id? state.data.users.find(u=>u.id===id) : {id:cryptoRand(), name:'', email:'', role:'employee', managerId:'', employment:'UOP', startDate:'', pass:'1', vacationDays:20};
  document.getElementById('empId').value=row.id;
  document.getElementById('empName').value=row.name||'';
  document.getElementById('empEmail').value=row.email||'';
  document.getElementById('empRole').value=row.role||'employee';
  document.getElementById('empManager').value=row.managerId||'';
  document.getElementById('empEmployment').value=row.employment||'UOP';
  document.getElementById('empStartDate').value=row.startDate||'';
  document.getElementById('empVacationDays').value=row.vacationDays??20;
  m.show();
}
async function saveEmpFromModal(ev){
  ev.preventDefault();
  if(state.user.role!=='admin'){ alert('Tylko administrator może edytować pracowników.'); return; }
  const row={ id:document.getElementById('empId').value, name:document.getElementById('empName').value, email:document.getElementById('empEmail').value, role:document.getElementById('empRole').value, managerId:document.getElementById('empManager').value||null, employment:document.getElementById('empEmployment').value||'UOP', startDate:document.getElementById('empStartDate').value||null, pass:(undefined), vacationDays:Number(document.getElementById('empVacationDays').value)||20 };
  const exists=state.data.users.find(u=>u.id===row.id);
  await api('/users'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)});
  await refresh();
  bootstrap.Modal.getInstance(document.getElementById('empModal')).hide();
}
async function deleteEmp(id){ if(state.user.role!=='admin'){ alert('Tylko administrator może usuwać.'); return; } await api('/users/'+id,{method:'DELETE'}); await refresh(); }

// ====== refresh & events
async function refresh(){ await sync(); renderAll(); }
function cryptoRand(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }

// ====== init
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const ok=await login(document.getElementById('loginEmail').value, document.getElementById('loginPass').value); if(!ok) alert('Nieprawidłowe dane logowania.'); });
  document.getElementById('btnLogout').addEventListener('click', ()=>{ clearInterval(window._poll); window._poll=null; location.reload(); });
  document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.target)));
  document.getElementById('calMonth').addEventListener('change', renderCalendar);
  document.getElementById('calEmployee').addEventListener('change', renderCalendar);
  document.getElementById('btnNewLeaveCal').addEventListener('click', ()=> openLeaveModal(null, (document.getElementById('calMonth').value||new Date().toISOString().slice(0,7))+'-01'));
  document.getElementById('btnNewLeave').addEventListener('click', ()=> openLeaveModal());
  document.getElementById('leaveForm').addEventListener('submit', saveLeaveFromModal);
  document.getElementById('leaveUser').addEventListener('change', ()=> fillLeaveTypes(document.getElementById('leaveType'), document.getElementById('leaveUser').value));

  // Delegacja klików (kalendarz/wnioski)
  document.body.addEventListener('click', (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const act=b.dataset.act, id=b.dataset.id;
    if(act==='approve-mgr') approveLeave(id,'mgr');
    if(act==='reject-mgr') rejectLeave(id,'mgr');
    if(act==='approve-adm') approveLeave(id,'adm');
    if(act==='reject-adm') rejectLeave(id,'adm');
    if(act==='editLeave') openLeaveModal(id);
    if(act==='delLeave') deleteLeave(id);
    if(act==='new-leave-day') openLeaveModal(null, b.dataset.date);
  });

  // raport (prosto)
  document.getElementById('reportForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const uid=document.getElementById('repEmployee').value;
    const mk=document.getElementById('repMonth').value;
    const [Y,M]=mk.split('-').map(Number);
    const days=getMonthDays(Y,M);
    const present=days.filter(d=> dayHasLeave(uid,Y,M,d).state==='present' && !isWeekend(new Date(`${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`))).length;
    const submitted=days.filter(d=> dayHasLeave(uid,Y,M,d).state==='submitted').length;
    const mgr=days.filter(d=> dayHasLeave(uid,Y,M,d).state==='manager_approved').length;
    const approved=days.filter(d=> dayHasLeave(uid,Y,M,d).state==='approved').length;
    const out=document.getElementById('repOut');
    out.innerHTML=`<div class='border rounded-4 p-3'>
      <div class='row text-center'>
        <div class='col'><div class='small text-muted'>Obecny</div><div class='fs-4'>${present}</div></div>
        <div class='col'><div class='small text-muted'>Wysłane</div><div class='fs-4'>${submitted}</div></div>
        <div class='col'><div class='small text-muted'>Po akcept. kier.</div><div class='fs-4'>${mgr}</div></div>
        <div class='col'><div class='small text-muted'>Zatwierdzone</div><div class='fs-4'>${approved}</div></div>
      </div>
    </div>`;
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
