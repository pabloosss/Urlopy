<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Emerlog Urlopy • alfa 0.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{--bg:#f5f8ff;--card:#ffffff;--primary:#2f6bff;}
    body{background:var(--bg);}
    .sidebar{width:300px; min-height:100vh;}
    .nav-link{border-radius:12px; padding:.8rem 1rem; font-weight:500;}
    .nav-link.active{background:#e6eeff; color:#1742b5;}
    .card{border:0; border-radius:16px; box-shadow:0 12px 30px rgba(26,55,126,.08)}
    .badge-role{font-size:.75rem}
    #loginBox{max-width:480px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
    .d-none{display:none!important}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="view-login" class="d-flex align-items-center justify-content-center vh-100">
  <div id="loginBox" class="card p-4">
    <h3 class="mb-3">Zaloguj się</h3>
    <p class="text-muted small mb-4">Demo: <code>admin@demo.local</code> / hasło <code>1</code></p>
    <form id="loginForm">
      <div class="mb-3">
        <label class="form-label">E-mail</label>
        <input id="loginEmail" type="email" class="form-control" required value="admin@demo.local">
      </div>
      <div class="mb-3">
        <label class="form-label">Hasło</label>
        <input id="loginPass" type="password" class="form-control" required value="1">
      </div>
      <button class="btn btn-primary w-100" type="submit"><i class="bi bi-box-arrow-in-right me-1"></i>Zaloguj</button>
    </form>
  </div>
</div>

<!-- APP -->
<div id="app" class="d-none">
  <div class="d-flex">
    <!-- sidebar -->
    <div class="sidebar p-3">
      <h5 class="mb-3">Emerlog Urlopy</h5>
      <div class="list-group">
        <a data-target="dashboard" class="nav-link active" href="#"><i class="bi bi-speedometer2 me-2"></i>Pulpit</a>
        <a data-target="calendar"  class="nav-link" href="#"><i class="bi bi-calendar3 me-2"></i>Kalendarz</a>
        <a data-target="leaves"    class="nav-link" href="#"><i class="bi bi-inbox me-2"></i>Wnioski</a>
        <a data-target="employees" class="nav-link" href="#"><i class="bi bi-people me-2"></i>Pracownicy</a>
        <a data-target="reports"   class="nav-link" href="#"><i class="bi bi-graph-up me-2"></i>Raporty</a>
      </div>
      <hr>
      <div class="small text-muted">
        Zalogowany: <span id="whoAmI">—</span><br>
        <button id="btnLogout" class="btn btn-sm btn-outline-secondary mt-2"><i class="bi bi-box-arrow-right me-1"></i>Wyloguj</button>
      </div>
    </div>

    <!-- content -->
    <div class="flex-fill p-4">
      <!-- header bar -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h4 class="mb-0" id="pageTitle">Pulpit</h4>
          <div class="text-muted small" id="pageSubtitle"></div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="btnNewLeave" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Nowy wniosek</button>
          <button id="btnBell" class="btn btn-light position-relative">
            <i class="bi bi-bell"></i>
            <span id="notifDot" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">!</span>
          </button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="view-dashboard">
        <div class="grid-3">
          <div class="card p-3">
            <div class="text-muted mb-1">Użytkownik</div>
            <div class="h5 mb-1" id="dashUser">—</div>
            <div class="small text-muted" id="dashRole">—</div>
          </div>
          <div class="card p-3">
            <div class="text-muted mb-1">Urlop (zostało / rok)</div>
            <div class="h5 mb-1"><span id="vacLeft">—</span> / <span id="vacYear">—</span> dni</div>
            <div class="small text-muted">Na żądanie: <span id="vacDemand">—</span> · Opieka: <span id="vacCare">—</span></div>
          </div>
          <div class="card p-3">
            <div class="text-muted mb-1">Wnioski do decyzji</div>
            <div class="h5 mb-0" id="pendingCount">0</div>
          </div>
        </div>
      </div>

      <!-- CALENDAR (placeholder prosty) -->
      <div id="view-calendar" class="d-none">
        <div class="card p-3">
          <div class="d-flex align-items-center gap-2">
            <label class="form-label me-2 mb-0">Pracownik:</label>
            <select id="calUser" class="form-select" style="max-width:320px"></select>
            <div class="ms-auto">
              <button id="calPrev" class="btn btn-light btn-sm"><i class="bi bi-chevron-left"></i></button>
              <span id="calMonth" class="mx-2 fw-semibold"></span>
              <button id="calNext" class="btn btn-light btn-sm"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
          <div id="calGrid" class="mt-3"></div>
        </div>
      </div>

      <!-- LEAVES -->
      <div id="view-leaves" class="d-none">
        <div class="card p-3">
          <div class="d-flex gap-2 mb-3">
            <select id="filterStatus" class="form-select" style="max-width:220px">
              <option value="">Wszystkie statusy</option>
              <option value="submitted">Oczekujące</option>
              <option value="approved_mgr">Zatwierdzone (kierownik)</option>
              <option value="approved">Zatwierdzone (admin)</option>
              <option value="rejected">Odrzucone</option>
            </select>
            <div class="ms-auto small text-muted">Widoczność wg roli: pracownik—swoje, manager—swoje+podopieczni, admin—wszystko</div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead><tr>
                <th>Pracownik</th><th>Typ</th><th>Od</th><th>Do</th><th>Dni</th><th>Status</th><th class="text-end">Akcje</th>
              </tr></thead>
              <tbody id="leavesTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EMPLOYEES -->
      <div id="view-employees" class="d-none">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Pracownicy</h5>
            <button id="btnAddEmp" class="btn btn-primary"><i class="bi bi-person-plus me-1"></i>Dodaj</button>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead><tr>
                <th>Imię i nazwisko</th><th>E-mail</th><th>Rola</th><th>Kierownik</th><th>Zatrudnienie</th><th>Start</th><th>Urlop/rok</th><th class="text-end">Akcje</th>
              </tr></thead>
              <tbody id="empTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- REPORTS (placeholder) -->
      <div id="view-reports" class="d-none">
        <div class="card p-4">
          <div class="text-muted">Raporty w przygotowaniu.</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal fade" id="empModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="empForm">
      <div class="modal-header"><h5 class="modal-title">Pracownik</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="emp_id">
        <div class="mb-2"><label class="form-label">Imię i nazwisko</label>
          <input id="emp_name" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">E-mail</label>
          <input id="emp_email" type="email" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Hasło (puste = „1”)</label>
          <input id="emp_pass" type="text" class="form-control" placeholder="1"></div>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Rola</label>
            <select id="emp_role" class="form-select">
              <option value="employee">employee</option>
              <option value="manager">manager</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Kierownik</label>
            <select id="emp_manager_id" class="form-select"></select>
          </div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <label class="form-label">Zatrudnienie</label>
            <select id="emp_employment" class="form-select">
              <option>UOP</option><option>JDG</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data startu</label>
            <input id="emp_start_date" type="date" class="form-control">
          </div>
        </div>
        <div class="mt-2">
          <label class="form-label">Urlop (dni/rok)</label>
          <input id="emp_vacation_days" type="number" min="0" class="form-control" value="20">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Anuluj</button>
        <button class="btn btn-primary" type="submit">Zapisz</button>
      </div>
    </form>
  </div>
</div>

<!-- LEAVE MODAL (skrót) -->
<div class="modal fade" id="leaveModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="leaveForm">
      <div class="modal-header"><h5 class="modal-title">Wniosek urlopowy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="leave_id">
        <div class="mb-2"><label class="form-label">Pracownik</label>
          <select id="leave_user_id" class="form-select"></select></div>
        <div class="mb-2"><label class="form-label">Typ</label>
          <select id="leave_type" class="form-select">
            <option>Urlop wypoczynkowy</option>
            <option>Urlop na żądanie</option>
            <option>Opieka nad dzieckiem</option>
            <option>Odbiór nadgodzin</option>
            <option>Odbiór za święto</option>
            <option>Choroba</option>
            <option>Urlop bezpłatny</option>
            <option>Urlop macierzyński</option>
            <option>Urlop ojcowski</option>
          </select></div>
        <div class="row g-2">
          <div class="col"><label class="form-label">Od</label><input id="leave_from" type="date" class="form-control" required></div>
          <div class="col"><label class="form-label">Do</label><input id="leave_to" type="date" class="form-control" required></div>
        </div>
        <div class="mt-2"><label class="form-label">Komentarz</label>
          <textarea id="leave_comment" class="form-control" rows="2"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Zamknij</button>
        <button class="btn btn-primary" type="submit">Wyślij</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const state = {
  token:null,
  me:null,
  users:[],
  leaves:[],
  month: new Date()
};

function showApp(on){ 
  document.getElementById('view-login').classList.toggle('d-none', on);
  document.getElementById('app').classList.toggle('d-none', !on);
}
function setActive(view){
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.classList.toggle('active', a.dataset.target===view);
  });
  ['dashboard','calendar','leaves','employees','reports'].forEach(v=>{
    document.getElementById('view-'+v).classList.toggle('d-none', v!==view);
  });
  document.getElementById('pageTitle').textContent=
    view==='dashboard'?'Pulpit':
    view==='calendar'?'Kalendarz':
    view==='leaves'?'Wnioski':
    view==='employees'?'Pracownicy':'Raporty';
}

async function api(path, opt={}){
  opt.headers = Object.assign({'Content-Type':'application/json'}, opt.headers||{});
  if(state.token) opt.headers['Authorization']='Bearer '+state.token;
  const r = await fetch(path, opt);
  if(!r.ok){
    const t = await r.text().catch(()=>r.statusText);
    throw new Error(t || ('HTTP '+r.status));
  }
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

// ===== AUTH
async function doLogin(email,pass){
  try{
    const j = await api('/auth/login',{method:'POST', body:JSON.stringify({email,pass})});
    state.token = j.token;
    localStorage.setItem('token', state.token);
    await bootstrapAfterLogin();
    return true;
  }catch(e){
    alert('Logowanie nieudane: '+e.message);
    return false;
  }
}
async function bootstrapAfterLogin(){
  // kto ja
  try{
    state.me = await api('/me');
  }catch{ // starsze serwery bez /me → pobierz z tokenu listę uż.
    state.me = {email:'', role:'employee', name:''};
  }
  document.getElementById('whoAmI').textContent = `${state.me?.name||''} · ${state.me?.role||''}`;

  // dane podstawowe
  await refreshAll();

  showApp(true);
  setActive('dashboard');
  renderDashboard();
  renderEmployees();
  renderLeaves();
  initCalendarSelectors();
  renderCalendar();
}

async function refreshAll(){
  [state.users, state.leaves] = await Promise.all([
    api('/users').catch(()=>[]),
    api('/leaves').catch(()=>[])
  ]);
}

// ====== RENDERERS
function renderDashboard(){
  const me = state.users.find(u=>u.id===state.me.id) || state.me || {};
  document.getElementById('dashUser').textContent = me.name || '—';
  document.getElementById('dashRole').textContent = me.role || '—';
  document.getElementById('vacYear').textContent = me.vacation_days ?? '—';
  // proste: „zostało” = rok (brak odliczania w tej wersji)
  document.getElementById('vacLeft').textContent = me.vacation_days ?? '—';
  document.getElementById('vacDemand').textContent = '—';
  document.getElementById('vacCare').textContent = '—';

  const canDecide = (state.me.role==='manager'||state.me.role==='admin');
  const myScopeIds = visibleUserIdsForRole();
  const pend = state.leaves.filter(l=> myScopeIds.includes(l.user_id) && l.status==='submitted');
  document.getElementById('pendingCount').textContent = canDecide? pend.length : 0;
  document.getElementById('notifDot').classList.toggle('d-none', !(canDecide && pend.length));
}

function visibleUserIdsForRole(){
  if(state.me.role==='admin') return state.users.map(u=>u.id);
  if(state.me.role==='manager'){
    const mine = [state.me.id];
    state.users.forEach(u=>{ if(u.manager_id===state.me.id) mine.push(u.id); });
    return mine;
  }
  return [state.me.id];
}

function renderEmployees(){
  const tb = document.getElementById('empTbody');
  tb.innerHTML='';
  const mgrMap = Object.fromEntries(state.users.map(u=>[u.id,u]));
  state.users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.name||'—'}</td>
      <td>${u.email||'—'}</td>
      <td><span class="badge text-bg-light">${u.role}</span></td>
      <td>${u.manager_id? (mgrMap[u.manager_id]?.name||'—') : '—'}</td>
      <td>${u.employment||'—'}</td>
      <td>${u.start_date||'—'}</td>
      <td>${u.vacation_days??'—'}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary me-2" data-act="edit" data-id="${u.id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${u.id}"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(tr);
  });

  // manager select in modal
  const sel = document.getElementById('emp_manager_id');
  sel.innerHTML = `<option value="">—</option>` + state.users
    .filter(x=>x.role!=='employee')
    .map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
}

function daysBetween(a,b){
  const d1=new Date(a), d2=new Date(b);
  if(isNaN(d1)||isNaN(d2)) return 0;
  return Math.floor( (d2-d1)/86400000 ) + 1;
}
function statusBadge(s){
  const map={submitted:'info', approved_mgr:'primary', approved:'success', rejected:'danger'};
  const txt={submitted:'Oczekuje', approved_mgr:'OK (kier.)', approved:'Zatwierdzony', rejected:'Odrzucony'};
  return `<span class="badge text-bg-${map[s]||'secondary'}">${txt[s]||s}</span>`;
}
function renderLeaves(){
  const tb = document.getElementById('leavesTbody');
  const filter = document.getElementById('filterStatus').value;
  const scope = visibleUserIdsForRole();
  const users = Object.fromEntries(state.users.map(u=>[u.id,u]));
  tb.innerHTML='';
  state.leaves
    .filter(l=> scope.includes(l.user_id))
    .filter(l=> !filter || l.status===filter)
    .sort((a,b)=> (a.from||'').localeCompare(b.from||''))
    .forEach(l=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${users[l.user_id]?.name||'—'}</td>
        <td>${l.type||'—'}</td>
        <td>${l.from||'—'}</td>
        <td>${l.to||'—'}</td>
        <td>${daysBetween(l.from,l.to)}</td>
        <td>${statusBadge(l.status)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary me-2" data-act="editLeave" data-id="${l.id}"><i class="bi bi-pencil"></i></button>
          ${state.me.role!=='employee' ? `
            <button class="btn btn-sm btn-outline-success me-2" data-act="approve" data-id="${l.id}"><i class="bi bi-check2"></i></button>
            <button class="btn btn-sm btn-outline-danger" data-act="reject" data-id="${l.id}"><i class="bi bi-x"></i></button>` : ''}
        </td>`;
      tb.appendChild(tr);
    });
}

// ===== CALENDAR (prosty render)
function ymStr(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function initCalendarSelectors(){
  const sel=document.getElementById('calUser');
  const ids = visibleUserIdsForRole();
  sel.innerHTML = state.users
    .filter(u=>ids.includes(u.id))
    .map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  sel.value = state.me.id;
}
function renderCalendar(){
  const host = document.getElementById('calGrid');
  const d=new Date(state.month.getFullYear(), state.month.getMonth(), 1);
  const monthLabel = d.toLocaleString('pl-PL',{month:'long', year:'numeric'});
  document.getElementById('calMonth').textContent = monthLabel;
  const userId = document.getElementById('calUser').value;
  const ym = ymStr(d);
  const list = state.leaves.filter(l=> l.user_id===userId && (l.from||'').startsWith(ym));
  let html = `<div class="row row-cols-7 g-2">`;
  for(let i=1;i<=31;i++){
    const day = new Date(d.getFullYear(), d.getMonth(), i);
    if(day.getMonth()!==d.getMonth()) break;
    const ds = day.toISOString().slice(0,10);
    const isLeave = list.some(l=> ds>=l.from && ds<=l.to && (l.status==='approved'||l.status==='approved_mgr'));
    html += `<div class="col">
      <div class="border rounded p-2 text-center ${isLeave?'bg-warning-subtle':''}">
        <div class="small">${i}</div>
      </div>
    </div>`;
  }
  html += `</div>`;
  host.innerHTML = html;
}

// ====== EMP MODAL
function openEmpModal(id){
  const u = id ? state.users.find(x=>x.id===id) : null;
  document.getElementById('emp_id').value = u?.id || '';
  document.getElementById('emp_name').value = u?.name || '';
  document.getElementById('emp_email').value = u?.email || '';
  document.getElementById('emp_pass').value = '';
  document.getElementById('emp_role').value = u?.role || 'employee';
  document.getElementById('emp_manager_id').value = u?.manager_id || '';
  document.getElementById('emp_employment').value = u?.employment || 'UOP';
  document.getElementById('emp_start_date').value = u?.start_date || '';
  document.getElementById('emp_vacation_days').value = u?.vacation_days ?? 20;
  new bootstrap.Modal('#empModal').show();
}
async function saveEmp(ev){
  ev.preventDefault();
  const id = document.getElementById('emp_id').value || undefined;
  const body = {
    id,
    name: document.getElementById('emp_name').value.trim(),
    email: document.getElementById('emp_email').value.trim(),
    pass: (document.getElementById('emp_pass').value.trim() || '1'),
    role: document.getElementById('emp_role').value,
    manager_id: document.getElementById('emp_manager_id').value || null,
    employment: document.getElementById('emp_employment').value,
    start_date: document.getElementById('emp_start_date').value || null,
    vacation_days: Number(document.getElementById('emp_vacation_days').value)||20
  };
  try{
    await api('/users'+(id?'/'+id:''), { method: id?'PUT':'POST', body: JSON.stringify(body) });
    await refreshAll();
    renderEmployees();
    renderDashboard();
    bootstrap.Modal.getInstance(document.getElementById('empModal')).hide();
  }catch(e){
    alert('Błąd zapisu użytkownika: '+e.message);
  }
}
async function deleteEmp(id){
  if(!confirm('Usunąć pracownika?')) return;
  try{
    await api('/users/'+id,{method:'DELETE'});
    await refreshAll();
    renderEmployees();
  }catch(e){
    alert('Nie udało się usunąć: '+e.message);
  }
}

// ====== LEAVES MODAL
function openLeaveModal(id){
  const scope = visibleUserIdsForRole();
  const sel=document.getElementById('leave_user_id');
  sel.innerHTML = state.users.filter(u=>scope.includes(u.id))
    .map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  const l = id ? state.leaves.find(x=>x.id===id) : {user_id: state.me.id, type:'Urlop wypoczynkowy', from:new Date().toISOString().slice(0,10), to:new Date().toISOString().slice(0,10), comment:''};
  document.getElementById('leave_id').value = l.id||'';
  sel.value = l.user_id;
  document.getElementById('leave_type').value = l.type;
  document.getElementById('leave_from').value = l.from;
  document.getElementById('leave_to').value = l.to;
  document.getElementById('leave_comment').value = l.comment||'';
  new bootstrap.Modal('#leaveModal').show();
}
async function saveLeave(ev){
  ev.preventDefault();
  const id = document.getElementById('leave_id').value||undefined;
  const body = {
    id,
    user_id: document.getElementById('leave_user_id').value,
    type: document.getElementById('leave_type').value,
    from: document.getElementById('leave_from').value,
    to: document.getElementById('leave_to').value,
    comment: document.getElementById('leave_comment').value,
    status: 'submitted'
  };
  try{
    await api('/leaves'+(id?'/'+id:''), {method: id?'PUT':'POST', body: JSON.stringify(body)});
    await refreshAll();
    renderLeaves(); renderCalendar(); renderDashboard();
    bootstrap.Modal.getInstance(document.getElementById('leaveModal')).hide();
  }catch(e){
    alert('Błąd zapisu wniosku: '+e.message);
  }
}
async function decideLeave(id, ok){
  try{
    await api('/leaves/'+id,{method:'PUT', body:JSON.stringify({ status: ok?'approved':'rejected' })});
    await refreshAll();
    renderLeaves(); renderCalendar(); renderDashboard();
  }catch(e){ alert('Błąd decyzji: '+e.message); }
}

// ====== EVENTS
document.getElementById('loginForm').addEventListener('submit', e=>{
  e.preventDefault(); doLogin(loginEmail.value, loginPass.value);
});
document.querySelectorAll('.nav-link').forEach(a=>{
  a.addEventListener('click', (e)=>{ e.preventDefault(); setActive(a.dataset.target); if(a.dataset.target==='calendar') renderCalendar(); });
});
document.getElementById('btnLogout').addEventListener('click', ()=>{
  state.token=null; localStorage.removeItem('token'); location.reload();
});
document.getElementById('btnAddEmp').addEventListener('click', ()=> openEmpModal());
document.getElementById('empForm').addEventListener('submit', saveEmp);
document.getElementById('empTbody').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id;
  if(b.dataset.act==='edit') openEmpModal(id);
  if(b.dataset.act==='del') deleteEmp(id);
});
document.getElementById('btnNewLeave').addEventListener('click', ()=> openLeaveModal());
document.getElementById('leaveForm').addEventListener('submit', saveLeave);
document.getElementById('leavesTbody').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id;
  if(b.dataset.act==='approve') decideLeave(id,true);
  if(b.dataset.act==='reject') decideLeave(id,false);
  if(b.dataset.act==='editLeave') openLeaveModal(id);
});
document.getElementById('filterStatus').addEventListener('change', renderLeaves);
document.getElementById('calPrev').addEventListener('click', ()=>{ state.month.setMonth(state.month.getMonth()-1); renderCalendar(); });
document.getElementById('calNext').addEventListener('click', ()=>{ state.month.setMonth(state.month.getMonth()+1); renderCalendar(); });
document.getElementById('calUser').addEventListener('change', renderCalendar);

// auto-login if token
(async ()=>{
  const t = localStorage.getItem('token');
  if(t){ state.token=t; try{ await bootstrapAfterLogin(); return; }catch{ /* ignore */ } }
  showApp(false);
})();
</script>
</body>
</html>
