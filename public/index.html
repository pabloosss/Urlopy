<!DOCTYPE html>
function showView(name){ ['dashboard','timesheet','leaves','employees','reports','settings'].forEach(v=>{ document.getElementById('view-'+v).style.display=(v===name)?'block':'none'; document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.classList.toggle('active',btn.dataset.target===name)); }); }
function userContractInfo(u){ const base=state.data.org.hoursPerDay||8; let m=20*base; if(u.contract==='0.75')m*=0.75; else if(u.contract==='0.5')m*=0.5; else if(u.contract==='custom'&&u.hoursMonthly)m=u.hoursMonthly; return Math.round(m); }
function renderDashboard(){ const u=state.user; const mk=monthKey(new Date()); const my=state.data.times.filter(t=>t.userId===u.id && t.date.startsWith(mk)); const today=new Date().toISOString().slice(0,10); const todayMin=my.filter(t=>t.date===today).reduce((a,t)=>a+workMinutes(t.start,t.end,t.break),0); const monthMin=my.reduce((a,t)=>a+workMinutes(t.start,t.end,t.break),0); document.getElementById('todayHours').textContent=fmtHM(todayMin); document.getElementById('monthHours').textContent=fmtHM(monthMin); document.getElementById('contractInfo').textContent=`${userContractInfo(u)} h / mies.`; const year=new Date().getFullYear(); const bal=vacationBalance(u,year); document.getElementById('vacationInfo').textContent=`${bal.left} / ${bal.entitled} dni`; }


function statusBadge(s){ const map={draft:'secondary',submitted:'info',approved:'success',rejected:'danger'}; const txt={draft:'Szkic',submitted:'Wysłany',approved:'Zatwierdzony',rejected:'Odrzucony'}; return `<span class="badge text-bg-${map[s||'draft']}">${txt[s||'draft']}</span>`; }
function renderTimes(){ const tbody=document.querySelector('#tsTable tbody'); tbody.innerHTML=''; const mk=document.getElementById('tsMonth').value; const list=state.data.times.filter(t=>t.userId===state.user.id && t.date.startsWith(mk)).sort((a,b)=>a.date.localeCompare(b.date)); for(const t of list){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.date}</td><td>${t.start||''}</td><td>${t.end||''}</td><td>${t.break||0}</td><td>${fmtHM(workMinutes(t.start,t.end,t.break))}</td><td>${t.project||''}</td><td>${t.note||''}</td><td>${statusBadge(t.status)}</td><td class='text-end'><button class='btn btn-sm btn-outline-secondary me-1' data-act='edit' data-id='${t.id}'><i class='fa-regular fa-pen-to-square'></i></button><button class='btn btn-sm btn-outline-danger' data-act='del' data-id='${t.id}'><i class='fa-regular fa-trash-can'></i></button></td>`; tbody.appendChild(tr);} }
function renderLeaves(){ const tbody=document.querySelector('#leaveTable tbody'); tbody.innerHTML=''; for(const l of [...state.data.leaves].sort((a,b)=>a.from.localeCompare(b.from))){ const u=state.data.users.find(x=>x.id===l.userId); const tr=document.createElement('tr'); tr.innerHTML=`<td>${u?.name||'—'}</td><td>${l.type}</td><td>${l.from}</td><td>${l.to}</td><td>${businessDaysBetween(l.from,l.to)}</td><td>${statusBadge(l.status)}</td><td class='text-end'><button class='btn btn-sm btn-success me-1' data-act='approve' data-id='${l.id}'><i class='fa-solid fa-check'></i></button><button class='btn btn-sm btn-danger me-1' data-act='reject' data-id='${l.id}'><i class='fa-solid fa-xmark'></i></button><button class='btn btn-sm btn-outline-secondary' data-act='editLeave' data-id='${l.id}'><i class='fa-regular fa-pen-to-square'></i></button></td>`; tbody.appendChild(tr);} }
function renderEmployees(){ const tbody=document.querySelector('#empTable tbody'); tbody.innerHTML=''; for(const u of state.data.users){ const mgr=state.data.users.find(x=>x.id===u.managerId); const contractText=(u.contract==='1.0')?'1.0':(u.contract==='0.75')?'0.75':(u.contract==='0.5')?'0.5':`${u.hoursMonthly||'—'} h/mies.`; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td><span class='badge text-bg-${u.role==='admin'?'dark':u.role==='manager'?'info':u.role==='hr'?'primary':'secondary'}'>${u.role}</span></td><td>${mgr?mgr.name:'—'}</td><td>${contractText}</td><td>${u.startDate||'—'}</td><td class='text-end'><button class='btn btn-sm btn-outline-secondary me-1' data-act='editEmp' data-id='${u.id}'><i class='fa-regular fa-pen-to-square'></i></button><button class='btn btn-sm btn-outline-danger' data-act='delEmp' data-id='${u.id}'><i class='fa-regular fa-trash-can'></i></button></td>`; tbody.appendChild(tr);} }
function renderRepEmployees(){ const sel=document.getElementById('repEmployee'); sel.innerHTML=''; for(const u of state.data.users){ sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`);} }
function renderTables(){ renderDashboard(); renderTimes(); renderLeaves(); renderEmployees(); renderRepEmployees(); }


function openTsModal(id){ const m=new bootstrap.Modal('#tsEditModal'); const isNew=!id; const row=isNew? {id:cryptoRand(), userId:state.user.id, date:new Date().toISOString().slice(0,10), start:'08:00', end:'16:00', break:30, project:'', note:'', status:'submitted'} : state.data.times.find(x=>x.id===id); document.getElementById('tsId').value=row.id; document.getElementById('tsDate').value=row.date; document.getElementById('tsStart').value=row.start||''; document.getElementById('tsEnd').value=row.end||''; document.getElementById('tsBreak').value=row.break||0; document.getElementById('tsProject').value=row.project||''; document.getElementById('tsNote').value=row.note||''; m.show(); }
async function saveTsFromModal(ev){ ev.preventDefault(); const row={ id:document.getElementById('tsId').value, userId:state.user.id, date:document.getElementById('tsDate').value, start:document.getElementById('tsStart').value, end:document.getElementById('tsEnd').value, break:Number(document.getElementById('tsBreak').value)||0, project:document.getElementById('tsProject').value, note:document.getElementById('tsNote').value, status:'submitted'}; const exists=state.data.times.find(x=>x.id===row.id); await api('/times'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)}); await refresh(); bootstrap.Modal.getInstance(document.getElementById('tsEditModal')).hide(); }
async function deleteTime(id){ await api('/times/'+id,{method:'DELETE'}); await refresh(); }


function openLeaveModal(id){ const m=new bootstrap.Modal('#leaveModal'); const sel=document.getElementById('leaveUser'); sel.innerHTML=''; for(const u of state.data.users){ sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`);} const row=id? state.data.leaves.find(x=>x.id===id) : {id:cryptoRand(), userId:state.user.id, type:'wypoczynkowy', from:new Date().toISOString().slice(0,10), to:new Date().toISOString().slice(0,10), comment:'', status:'submitted'}; document.getElementById('leaveId').value=row.id; document.getElementById('leaveUser').value=row.userId; document.getElementById('leaveType').value=row.type; document.getElementById('leaveFrom').value=row.from; document.getElementById('leaveTo').value=row.to; document.getElementById('leaveComment').value=row.comment||''; m.show(); }
async function saveLeaveFromModal(ev){ ev.preventDefault(); const row={ id:document.getElementById('leaveId').value, userId:document.getElementById('leaveUser').value, type:document.getElementById('leaveType').value, from:document.getElementById('leaveFrom').value, to:document.getElementById('leaveTo').value, comment:document.getElementById('leaveComment').value, status:'submitted'}; const exists=state.data.leaves.find(x=>x.id===row.id); await api('/leaves'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)}); await refresh(); bootstrap.Modal.getInstance(document.getElementById('leaveModal')).hide(); }
async function approveLeave(id, ok){ await api('/leaves/'+id,{method:'PUT', body: JSON.stringify({ status: ok?'approved':'rejected' })}); await refresh(); }


function openEmpModal(id){ const m=new bootstrap.Modal('#empModal'); const sel=document.getElementById('empManager'); sel.innerHTML='<option value="">—</option>'; state.data.users.filter(u=>u.role!=='employee').forEach(u=> sel.insertAdjacentHTML('beforeend',`<option value='${u.id}'>${u.name}</option>`)); const row=id? state.data.users.find(u=>u.id===id) : {id:cryptoRand(), name:'', email:'', role:'employee', managerId:'', contract:'1.0', hoursMonthly:null, startDate:'', pass:'1', vacationDays:26}; document.getElementById('empId').value=row.id; document.getElementById('empName').value=row.name||''; document.getElementById('empEmail').value=row.email||''; document.getElementById('empRole').value=row.role||'employee'; document.getElementById('empManager').value=row.managerId||''; document.getElementById('empContract').value=row.contract||'1.0'; document.getElementById('empHoursMonthly').value=row.hoursMonthly||''; document.getElementById('empStartDate').value=row.startDate||''; document.getElementById('empPass').value=''; document.getElementById('empVacationDays').value=row.vacationDays??26; m.show(); }
async function saveEmpFromModal(ev){ ev.preventDefault(); const row={ id:document.getElementById('empId').value, name:document.getElementById('empName').value, email:document.getElementById('empEmail').value, role:document.getElementById('empRole').value, managerId:document.getElementById('empManager').value||null, contract:document.getElementById('empContract').value, hoursMonthly:Number(document.getElementById('empHoursMonthly').value)||null, startDate:document.getElementById('empStartDate').value||null, pass:(document.getElementById('empPass').value||undefined), vacationDays:Number(document.getElementById('empVacationDays').value)||26 }; const exists=state.data.users.find(u=>u.id===row.id); await api('/users'+(exists?('/'+row.id):''),{ method: exists?'PUT':'POST', body: JSON.stringify(row)}); await refresh(); bootstrap.Modal.getInstance(document.getElementById('empModal')).hide(); }
async function deleteEmp(id){ await api('/users/'+id,{method:'DELETE'}); await refresh(); }


async function refresh(){ await sync(); renderTables(); }
function cryptoRand(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }


// ====== export CSV (bieżący miesiąc/pracownik) ======
function exportCSV(){ const mk=document.getElementById('tsMonth').value; const list=state.data.times.filter(t=>t.userId===state.user.id && t.date.startsWith(mk)).sort((a,b)=>a.date.localeCompare(b.date)); const rows=[['Data','Start','Koniec','Przerwa(min)','Godziny','Projekt','Notatka','Status']]; for(const t of list){ rows.push([t.date,t.start||'',t.end||'',t.break||0,fmtHM(workMinutes(t.start,t.end,t.break)),t.project||'',t.note||'',t.status]); } const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`times_${state.user.email}_${mk}.csv`; a.click(); URL.revokeObjectURL(a.href); }


// ====== ustawienia ======
document.addEventListener('DOMContentLoaded', ()=>{
document.getElementById('loginForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const ok=await login(document.getElementById('loginEmail').value, document.getElementById('loginPass').value); if(!ok) alert('Nieprawidłowe dane logowania.'); });
document.getElementById('btnLogout').addEventListener('click', ()=>{ clearInterval(window._poll); window._poll=null; location.reload(); });
document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.target)));
document.getElementById('btnAddRow').addEventListener('click', ()=> openTsModal());
document.getElementById('tsEditForm').addEventListener('submit', saveTsFromModal);
document.getElementById('tsMonth').addEventListener('change', renderTimes);
document.getElementById('tsTable').addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id; const act=b.dataset.act; if(act==='edit') openTsModal(id); if(act==='del') deleteTime(id); });
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);


document.getElementById('btnNewLeave').addEventListener('click', ()=> openLeaveModal());
document.getElementById('leaveForm').addEventListener('submit', saveLeaveFromModal);
document.getElementById('leaveTable').addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id; const act=b.dataset.act; if(act==='approve') approveLeave(id,true); if(act==='reject') approveLeave(id,false); if(act==='editLeave') openLeaveModal(id); });


document.getElementById('btnNewEmp').addEventListener('click', ()=> openEmpModal());
document.getElementById('empForm').addEventListener('submit', saveEmpFromModal);
document.getElementById('empTable').addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id; const act=b.dataset.act; if(act==='editEmp') openEmpModal(id); if(act==='delEmp') deleteEmp(id); });


document.getElementById('reportForm').addEventListener('submit', (e)=>{ e.preventDefault(); const uid=document.getElementById('repEmployee').value; const month=document.getElementById('repMonth').value; const list=state.data.times.filter(t=>t.userId===uid && t.date.
