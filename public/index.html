<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerlog Urlopy alfa 0.1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --primary:#0d6efd; --bg:#f6f9ff;
      --submitted:#fff4e5; --mgr:#e7f1ff; --approved:#d1e7dd; --rejected:#fde2e2; --weekend:#f0f0f0; --todayOutline:#0d6efd;
    }
    body{background:var(--bg)}
    .brand-bar{background:linear-gradient(90deg,var(--primary),#37a0ff);color:#fff}
    .shadow-soft{box-shadow:0 8px 20px rgba(13,110,253,.12)}
    .card{border:0;border-radius:1rem} .btn{border-radius:.8rem}
    .nav-pills .nav-link.active{background:var(--primary)}
    .table thead th{background:#eef5ff}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem;}
    .cal-grid>.head{font-size:.8rem;color:#6c757d;text-align:center}
    .cal-day{border-radius:.8rem;padding:.5rem;min-height:84px;border:1px solid #e9ecef;position:relative}
    .cal-day .d{position:absolute;top:.35rem;right:.5rem;font-size:.8rem;color:#6c757d}
    .cal-day.submitted{background:var(--submitted)} .cal-day.manager_approved{background:var(--mgr)}
    .cal-day.approved{background:var(--approved)} .cal-day.rejected{background:var(--rejected)}
    .cal-day.weekend{background:var(--weekend)} .cal-day.today{outline:2px solid var(--todayOutline); outline-offset:-2px}
  </style>
</head>
<body>
<header class="brand-bar py-2 shadow-soft">
  <div class="container d-flex align-items-center gap-3">
    <h1 class="h6 mb-0 fw-bold">Emerlog Urlopy alfa 0.1</h1>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="loggedAs" class="small"></span>
      <button class="btn btn-light btn-sm" id="btnLogout" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Wyloguj</button>
    </div>
  </div>
</header>

<main class="container my-4">
  <!-- LOGOWANIE -->
  <section id="authSection" class="row justify-content-center">
    <div class="col-lg-5">
      <div class="card shadow-soft"><div class="card-body p-4">
        <div class="text-center mb-3">
          <div class="display-6">Zaloguj się</div>
          <div class="text-muted">Demo: admin/manager/worker · hasło: 1</div>
        </div>
        <form id="loginForm">
          <div class="mb-3"><label class="form-label">E-mail</label><input type="email" class="form-control" id="loginEmail" required value="admin@demo.local"></div>
          <div class="mb-3"><label class="form-label">Hasło</label><input type="password" class="form-control" id="loginPass" required value="1"></div>
          <button class="btn btn-outline-dark w-100" type="submit"><i class="fa-solid fa-right-to-bracket"></i> Zaloguj</button>
        </form>
      </div></div>
    </div>
  </section>

  <!-- APLIKACJA -->
  <section id="appSection" style="display:none">
    <div class="row g-3">
      <div class="col-lg-3">
        <div class="card shadow-soft"><div class="card-body">
          <ul class="nav nav-pills flex-column gap-2" id="mainNav">
            <li class="nav-item"><button data-target="dashboard" class="nav-link active w-100 text-start"><i class="fa-solid fa-gauge-high me-2"></i>Pulpit</button></li>
            <li class="nav-item"><button data-target="calendar" class="nav-link w-100 text-start"><i class="fa-regular fa-calendar me-2"></i>Kalendarz</button></li>
            <li class="nav-item"><button data-target="leaves" class="nav-link w-100 text-start"><i class="fa-regular fa-calendar-days me-2"></i>Wnioski</button></li>
            <li class="nav-item"><button data-target="employees" class="nav-link w-100 text-start"><i class="fa-solid fa-id-card me-2"></i>Pracownicy</button></li>
            <li class="nav-item"><button data-target="reports" class="nav-link w-100 text-start"><i class="fa-solid fa-chart-simple me-2"></i>Raporty</button></li>
          </ul>
        </div></div>
      </div>

      <div class="col-lg-9">
        <div id="view-dashboard" class="card shadow-soft"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="h5 mb-1" id="dashHello">Witaj</div>
              <div class="text-muted small" id="dashDate"></div>
            </div>
          </div>
          <div class="alert alert-info mb-0">Tu będzie pulpit. Skupiamy się na naprawie „Pracownicy”.</div>
        </div></div>

        <!-- PRACOWNICY -->
        <div id="view-employees" class="card shadow-soft mt-3" style="display:none"><div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Pracownicy</h2>
            <button class="btn btn-primary btn-sm" id="btnNewEmp"><i class="fa-solid fa-user-plus"></i> Dodaj</button>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="empTable">
              <thead><tr>
                <th>Imię i nazwisko</th><th>E-mail</th><th>Rola</th><th>Kierownik</th><th>Zatrudnienie</th><th>Start</th><th>Urlop (dni/rok)</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div></div>

        <!-- KALENDARZ / WNIOSKI / RAPORTY (placeholdery) -->
        <div id="view-calendar" class="card shadow-soft mt-3" style="display:none"><div class="card-body">Kalendarz – w skrócie.</div></div>
        <div id="view-leaves" class="card shadow-soft mt-3" style="display:none"><div class="card-body">Wnioski – w skrócie.</div></div>
        <div id="view-reports" class="card shadow-soft mt-3" style="display:none"><div class="card-body">Raporty – w skrócie.</div></div>
      </div>
    </div>
  </section>
</main>

<!-- MODAL PRACOWNIKA -->
<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Dane pracownika</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <form id="empForm" class="modal-body row g-3">
    <input type="hidden" id="empId">
    <div class="col-md-6"><label class="form-label">Imię i nazwisko</label><input class="form-control" id="empName" required></div>
    <div class="col-md-6"><label class="form-label">E-mail (login)</label><input type="email" class="form-control" id="empEmail" required></div>
    <div class="col-md-4"><label class="form-label">Rola</label>
      <select class="form-select" id="empRole" required>
        <option value="employee">Pracownik</option>
        <option value="manager">Kierownik</option>
        <option value="admin">Administrator</option>
      </select>
    </div>
    <div class="col-md-4"><label class="form-label">Kierownik</label><select class="form-select" id="empManager"></select></div>
    <div class="col-md-4"><label class="form-label">Zatrudnienie</label>
      <select class="form-select" id="empEmployment">
        <option value="UOP">UOP</option>
        <option value="JDG">JDG</option>
      </select>
    </div>
    <div class="col-md-4"><label class="form-label">Start zatrudnienia</label><input type="date" class="form-control" id="empStartDate"></div>
    <div class="col-md-4"><label class="form-label">Urlop (dni/rok)</label><input type="number" class="form-control" id="empVacationDays" min="0" step="1" value="20"></div>
    <div class="col-md-4"><label class="form-label">Hasło (zostaw puste, by nie zmieniać)</label><input type="password" class="form-control" id="empPass" placeholder="●●●●●"></div>
    <div class="col-12 d-flex justify-content-end gap-2">
      <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Anuluj</button>
      <button class="btn btn-primary" type="submit">Zapisz</button>
    </div>
  </form>
</div></div></div>

<script>
const API_BASE=''; let TOKEN=null;
const state={ user:null, data:{users:[], leaves:[], org:{hoursPerDay:8}} };

async function api(path,opts={}){
  opts.headers=Object.assign({'Content-Type':'application/json'},opts.headers||{});
  if(TOKEN) opts.headers.Authorization='Bearer '+TOKEN;
  const r=await fetch(API_BASE+path,opts);
  const txt=await r.text();
  if(!r.ok){
    try{ const j=JSON.parse(txt); alert(j.error||txt); }
    catch{ alert(txt||'Błąd żądania'); }
    throw new Error(txt);
  }
  return txt? JSON.parse(txt): null;
}

function userById(id){ return state.data.users.find(u=>u.id===id); }
function subordinatesOf(managerId){ return state.data.users.filter(u=>u.managerId===managerId); }
function monthKey(d){ d=new Date(d); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }

async function login(email,pass){
  try{
    const r=await api('/auth/login',{method:'POST',body:JSON.stringify({email,pass})});
    TOKEN=r.token; state.user=r.user;
    await sync(); renderAfterLogin(); return true;
  }catch(e){ return false; }
}
async function sync(){
  const users=await api('/users'); const leaves=await api('/leaves');
  state.data={users, leaves, org:{hoursPerDay:8}};
}

function renderAfterLogin(){
  document.getElementById('authSection').style.display='none';
  document.getElementById('appSection').style.display='block';
  document.getElementById('btnLogout').style.display='inline-flex';
  document.getElementById('loggedAs').textContent=`${state.user.name} (${state.user.email})`;
  document.getElementById('dashDate').textContent=new Date().toLocaleString('pl-PL',{dateStyle:'full'});
  document.getElementById('dashHello').textContent=`${state.user.name} · ${state.user.role}`;
  renderEmployees();
  showView('employees'); // od razu na widok pracowników, żeby testować
}

function showView(name){
  ['dashboard','calendar','leaves','employees','reports'].forEach(v=>{
    document.getElementById('view-'+v).style.display=(v===name)?'block':'none';
    document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.classList.toggle('active',btn.dataset.target===name));
  });
}

// ====== EMPLOYEES ======
function renderEmployees(){
  console.debug('renderEmployees');
  const tbody=document.querySelector('#empTable tbody'); tbody.innerHTML='';
  let list=[];
  if(state.user.role==='admin') list=[...state.data.users];
  else if(state.user.role==='manager') list=[ userById(state.user.id), ...subordinatesOf(state.user.id) ];
  else list=[ userById(state.user.id) ];
  list.sort((a,b)=> (a.name||'').localeCompare(b.name||'','pl'));
  for(const u of list){
    const mgr=userById(u.managerId||'');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${u.name||'—'}</td>
      <td>${u.email||'—'}</td>
      <td><span class='badge text-bg-${u.role==='admin'?'dark':u.role==='manager'?'info':'secondary'}'>${u.role}</span></td>
      <td>${mgr?mgr.name:'—'}</td>
      <td>${u.employment||'UOP'}</td>
      <td>${u.startDate||'—'}</td>
      <td>${u.vacationDays??20}</td>
      <td class="text-end">
        ${state.user.role==='admin'
          ? `<button class="btn btn-sm btn-outline-secondary me-1" data-act="editEmp" data-id="${u.id}"><i class="fa-regular fa-pen-to-square"></i></button>
             <button class="btn btn-sm btn-outline-danger" data-act="delEmp" data-id="${u.id}"><i class="fa-regular fa-trash-can"></i></button>`
          : ''
        }
      </td>`;
    tbody.appendChild(tr);
  }
}

function openEmpModal(id){
  if(state.user.role!=='admin'){ alert('Tylko administrator może edytować pracowników.'); return; }
  console.debug('openEmpModal', id);
  const m=new bootstrap.Modal('#empModal');
  const sel=document.getElementById('empManager'); sel.innerHTML='<option value="">—</option>';
  state.data.users.filter(u=>u.role!=='employee').forEach(u=> sel.insertAdjacentHTML('beforeend',`<option value="${u.id}">${u.name}</option>`));
  const row=id? state.data.users.find(u=>u.id===id) : {id:randId(), name:'', email:'', role:'employee', managerId:'', employment:'UOP', startDate:'', vacationDays:20};
  document.getElementById('empId').value=row.id||'';
  document.getElementById('empName').value=row.name||'';
  document.getElementById('empEmail').value=row.email||'';
  document.getElementById('empRole').value=row.role||'employee';
  document.getElementById('empManager').value=row.managerId||'';
  document.getElementById('empEmployment').value=row.employment||'UOP';
  document.getElementById('empStartDate').value=row.startDate||'';
  document.getElementById('empVacationDays').value=row.vacationDays??20;
  document.getElementById('empPass').value='';
  m.show();
}

async function saveEmpFromModal(ev){
  ev.preventDefault();
  if(state.user.role!=='admin'){ alert('Tylko administrator może edytować.'); return; }
  const id=document.getElementById('empId').value || randId();
  const payload={
    id,
    name: document.getElementById('empName').value.trim(),
    email: document.getElementById('empEmail').value.trim(),
    role: document.getElementById('empRole').value,
    managerId: document.getElementById('empManager').value || null,
    employment: document.getElementById('empEmployment').value || 'UOP',
    startDate: document.getElementById('empStartDate').value || null,
    vacationDays: Number(document.getElementById('empVacationDays').value)||20
  };
  const pass = document.getElementById('empPass').value;
  if(pass) payload.pass = pass; // tylko jeśli podano

  const exists = state.data.users.find(u=>u.id===id);
  console.debug('saveEmpFromModal', exists?'UPDATE':'CREATE', payload);

  const r = await api('/users'+(exists?('/'+id):''),{
    method: exists?'PUT':'POST',
    body: JSON.stringify(payload)
  });
  await refresh();
  bootstrap.Modal.getInstance(document.getElementById('empModal')).hide();
}

async function deleteEmp(id){
  if(state.user.role!=='admin'){ alert('Tylko administrator może usuwać.'); return; }
  if(!confirm('Usunąć pracownika?')) return;
  await api('/users/'+id,{method:'DELETE'});
  await refresh();
}

function randId(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }

// ====== REFRESH / NAV / HANDLERS
async function refresh(){ await sync(); renderEmployees(); }

document.addEventListener('DOMContentLoaded', ()=>{
  // logowanie
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const ok = await login(document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
    if(!ok) alert('Nieprawidłowe dane logowania.');
  });
  document.getElementById('btnLogout').addEventListener('click', ()=>{ clearInterval(window._poll); window._poll=null; location.reload(); });

  // nawigacja
  document.querySelectorAll('#mainNav [data-target]').forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.target)));

  // *** KLUCZOWE LISTENERY PRACOWNIKÓW ***
  document.getElementById('btnNewEmp').addEventListener('click', ()=> openEmpModal());
  document.getElementById('empForm').addEventListener('submit', saveEmpFromModal);
  document.getElementById('empTable').addEventListener('click', (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id; const act=b.dataset.act || (b.classList.contains('btn-outline-danger')?'delEmp':'editEmp');
    console.debug('empTable click', act, id);
    if(act==='editEmp') openEmpModal(id);
    if(act==='delEmp') deleteEmp(id);
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
